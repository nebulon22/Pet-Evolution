<!DOCTYPE html>
<html>
<head>
  <title>Pet Evolusi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- Layout & styles --- */
    body { margin:0; text-align:center; background:#2e7d32; color:white; font-family:sans-serif; overflow-x:hidden; display:flex; flex-direction:column; align-items:center; }
    h2 { margin-top:10px; font-size:6vw; }

    #coinDisplay { position:fixed; top:5px; left:5px; font-size:4vw; background:rgba(0,0,0,0.3); padding:4px 8px; border-radius:6px; z-index:10; }
    #shopBtn { position: fixed; top: 50px; left: 5px; font-size: 4vw; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 6px; z-index: 10; cursor: pointer; }

    .pet-wrapper { position:relative; display:flex; align-items:center; justify-content:center; margin-top:20px; gap:20px; overflow:hidden; width:100%; max-width:420px; }

    .glow { position:absolute; width:240px; height:240px; background:radial-gradient(circle, rgba(255,255,200,0.9) 0%, transparent 70%); animation:glow 2s infinite; border-radius:50%; z-index:0; display:none; left:50%; transform:translateX(-50%); top:18%; }
    @keyframes glow { 0%,100%{opacity:0; transform:translateX(-50%) scale(1);} 50%{opacity:0.9; transform:translateX(-50%) scale(1.18);} }
    .sparkle { position:absolute; width:8px; height:8px; background:white; border-radius:50%; opacity:0.9; animation:sparkleMove 1.5s forwards; pointer-events:none; z-index:2; }
    @keyframes sparkleMove { 0%{transform:translateY(0) scale(1);opacity:1;} 100%{transform:translateY(-60px) scale(0.4);opacity:0;} }

    #pet { width:40vw; max-width:220px; height:auto; z-index:2; transition:transform 0.15s ease; user-select:none; -webkit-user-drag:none; }
    .breathing{ animation:breathing 3s infinite; }
    @keyframes breathing { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
    .hungry { animation:hungry-shake 0.5s infinite; }
    @keyframes hungry-shake { 0%,100%{transform:translateX(0);} 25%{transform:translateX(-8px);} 75%{transform:translateX(8px);} }

    .thermometer { display:flex; flex-direction:column-reverse; justify-content:flex-start; width:40px; height:220px; border:2px solid #ccc; border-radius:6px; overflow:hidden; background:#666; position:relative; z-index:2; margin-right:8px; }
    .bar { flex:1; margin:1px 0; background:#666; opacity:0.4; }
    .bar.active { opacity:1; }
    .bar:nth-child(2).active{background:#800000;}
    .bar:nth-child(3).active{background:#b22222;}
    .bar:nth-child(4).active{background:#ff4500;}
    .bar:nth-child(5).active{background:#ff8c00;}
    .bar:nth-child(6).active{background:#ffd700;}
    .bar:nth-child(7).active{background:#f0e68c;}
    .bar:nth-child(8).active{background:#adff2f;}
    .bar:nth-child(9).active{background:#7fff00;}
    .bar:nth-child(10).active{background:#32cd32;}
    .bar:nth-child(11).active{background:#00ff00;}
    .thermo-label { position:absolute; left:50%; transform:translateX(-50%); font-size:2.8vw; color:white; text-shadow:1px 1px 2px black; }
    #labelTop { top:2px; } #labelBottom { bottom:2px; }

    #bubble { position:absolute; left:60%; top:10%; background:white; color:black; padding:8px 12px; border-radius:12px; display:none; max-width:180px; text-align:left; z-index:3; font-size:3.5vw; }
    #bubble::after { content:""; position:absolute; left:-10px; top:20px; border-width:10px; border-style:solid; border-color:transparent white transparent transparent; }

    .bar-container { width:80vw; max-width:500px; margin:10px auto; background:#444; border-radius:10px; overflow:hidden; height:24px; }
    #expBar { height:100%; width:0%; text-align:center; color:white; font-size:3.5vw; line-height:24px; background:dodgerblue; transition:width 0.5s ease; }

    button { margin:10px; padding:12px 24px; font-size:4vw; border-radius:10px; }
    button:disabled { opacity:0.5; background:#777 !important; cursor:not-allowed; }

    #resetWrapper { position:fixed; top:5px; right:5px; z-index:10; }
    #resetBtn { font-size:2.5vw; padding:4px 8px; border-radius:6px; opacity:0.6; }
    #resetBtn:hover { opacity:1; }

    #plateWrapper { position:relative; margin-top:20px; z-index:2; }
    #plate { width:180px; user-select:none; -webkit-user-drag:none; }
    #plateFood { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:50%; height:50%; object-fit:contain; display:none; pointer-events:none; }

    #foodItems { display:flex; gap:15px; justify-content:center; margin-top:10px; z-index:2; }
    .foodItem { position:relative; width:60px; touch-action: none; }
    .foodItem img { width:100%; user-select:none; -webkit-user-drag:none; }
    .count { position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.7); font-size:14px; padding:2px 5px; border-radius:8px; }

    .flytext { position:absolute; left:50%; transform:translateX(-50%); bottom:110%; font-size:12px; color:#fff; text-shadow:1px 1px 2px black; opacity:0; animation:flyUp 1s forwards; pointer-events:none; }
    @keyframes flyUp { 0% { transform:translateX(-50%) translateY(0); opacity:1; } 100% { transform:translateX(-50%) translateY(-30px); opacity:0; } }

    #shopPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; color: black; padding: 15px; border-radius: 12px; display: none; z-index: 40; width: 85%; max-width: 320px; box-shadow: 0 0 12px rgba(0,0,0,0.6); }
    #shopItems { display:flex; gap:15px; justify-content:center; margin-top:10px; }
    .shopItem { position:relative; width:70px; cursor:pointer; }
    .shopItem img { width:100%; user-select:none; -webkit-user-drag:none; }
    .price { position:absolute; bottom:-18px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; font-size:12px; padding:2px 5px; border-radius:8px; }
    #shopClose { margin-top:15px; padding:8px 16px; }

    #battleBtn { position: fixed; bottom: 10px; right: 10px; font-size: 3.5vw; background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 50%; cursor: pointer; z-index: 20; }
    #battlePopup, #hostPopup { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: white; color: black; padding: 15px; border-radius: 12px; display: none; z-index: 40; width: 85%; max-width: 320px; box-shadow: 0 0 12px rgba(0,0,0,0.6); text-align: center; }
    #battlePopup button, #hostPopup button { margin: 8px; padding: 8px 16px; font-size: 4vw; border-radius: 8px; }

    #arena { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:linear-gradient(180deg,#111 0%, #000 100%); color:white; z-index:50; text-align:center; padding-top:40px; }
    #arena button { margin:10px; padding:12px 24px; font-size:5vw; }
    #arena .arena-row { display:flex; justify-content:space-around; align-items:center; width:100%; max-width:720px; margin:10px auto; }
    #arena .pet-small { width:28vw; max-width:140px; user-select:none; -webkit-user-drag:none; }
  </style>
</head>
<body>
  <h2>üê£ Pet Evolusi</h2>

  <div id="coinDisplay">üí∞ 0</div>
  <div id="shopBtn" onclick="toggleShop(true)">üõí Shop</div>
  <div id="resetWrapper"><button id="resetBtn" onclick="resetGame()">üîÑ</button></div>

  <div class="pet-wrapper" id="petWrapper">
    <div class="glow" id="evoGlow"></div>
    <img id="pet" src="images/egg.png" class="breathing" draggable="false" alt="Pet">
    <div id="bubble"></div>
  </div>

  <p style="font-size:4vw;">Level Pet: <span id="level">1</span></p>
  <div class="bar-container"><div id="expBar">EXP 0%</div></div>

  <button onclick="feedPet()" id="feedBtn">üçñ Feed</button>
  <button id="playBtn">üéÆ Play</button>
  <button id="evoBtn" style="display:none;" onclick="evolvePet()">‚ú® Evo Sekarang!</button>

  <div id="plateWrapper">
    <img id="plate" src="images/plate.png" alt="Piring" draggable="false">
    <img id="plateFood" src="" alt="" draggable="false">
  </div>

  <div id="foodItems">
    <div class="foodItem" data-food="meat" onmousedown="startDragMouse(event,'meat')" ontouchstart="startDrag(event,'meat')">
      <img src="images/meat.png" draggable="false"><div class="count" id="count-meat">100</div>
    </div>
    <div class="foodItem" data-food="fruit" onmousedown="startDragMouse(event,'fruit')" ontouchstart="startDrag(event,'fruit')">
      <img src="images/fruit.png" draggable="false"><div class="count" id="count-fruit">100</div>
    </div>
    <div class="foodItem" data-food="leaf" onmousedown="startDragMouse(event,'leaf')" ontouchstart="startDrag(event,'leaf')">
      <img src="images/leaf.png" draggable="false"><div class="count" id="count-leaf">100</div>
    </div>
  </div>

  <div id="battleBtn" onclick="openBattleChoice()">‚öîÔ∏è</div>

  <div id="battlePopup">
    <h3>Pilih Mode Battle</h3>
    <p><label>Arena ID:</label><br>
    <input type="text" id="arenaInput" value="arena1" style="font-size:4vw; padding:4px; text-align:center; width:80%;"></p>
    <button onclick="chooseHost()">üè† Host</button>
    <button onclick="chooseClient()">üì± Client</button><br>
    <button onclick="closeBattle()">Tutup</button>
  </div>

  <div id="hostPopup">
    <h3>Host Battle</h3>
    <p>Buka <b>Termux</b> lalu jalankan:<br><code>node server.js</code></p>
    <p>Setelah server aktif, klik Lanjutkan.</p>
    <button onclick="connectAsHost()">Lanjutkan</button>
    <button onclick="closeHost()">Tutup</button>
  </div>

  <div id="arena">
    <h2>‚öîÔ∏è Arena Battle</h2>
    <div class="arena-row">
      <div>
        <img id="arenaMyPet" class="pet-small" src="images/egg.png" alt="My Pet">
        <p id="myHP">HP: 100</p>
      </div>
      <div>
        <img id="arenaEnemyPet" class="pet-small" src="images/egg.png" alt="Enemy Pet">
        <p id="enemyHP">HP: 100</p>
      </div>
    </div>
    <div style="margin-top:18px;">
      <button onclick="sendAction('attack')">üî™ Attack</button>
      <button onclick="sendAction('dodge')">‚ÜîÔ∏è Dodge</button>
      <button onclick="sendAction('skill')">‚ú® Skill</button>
    </div>
    <p id="log">Menunggu aksi...</p>
    <button onclick="exitArena()">Keluar Arena</button>
  </div>

  <div id="shopPopup">
    <h3>üõí Shop</h3>
    <div id="shopItems">
      <div class="shopItem" onclick="buyItem('meat',10)"><img src="images/meat.png" draggable="false"><div class="price">üí∞10</div></div>
      <div class="shopItem" onclick="buyItem('fruit',5)"><img src="images/fruit.png" draggable="false"><div class="price">üí∞5</div></div>
      <div class="shopItem" onclick="buyItem('leaf',3)"><img src="images/leaf.png" draggable="false"><div class="price">üí∞3</div></div>
    </div>
    <button id="shopClose" onclick="toggleShop(false)">Tutup</button>
  </div>

  <audio id="soundFeed" src="sounds/feed.mp3" preload="auto"></audio>
  <audio id="soundLevel" src="sounds/levelup.mp3" preload="auto"></audio>
  <audio id="soundEvo" src="sounds/evo.mp3" preload="auto"></audio>
  <audio id="soundCoin" src="sounds/coin.mp3" preload="auto"></audio>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
  /* ================= State & Init ================= */
  let pet = JSON.parse(localStorage.getItem("petData")) || { level:1, exp:0, stage:"egg", hunger:30, coins:0 };
  let foodStock = JSON.parse(localStorage.getItem("foodStock")) || { meat:100, fruit:100, leaf:100 };
  let selectedFood = null;
  let socket = null;
  let arenaId = "arena1";

  function getPetImage(stage){
    if(stage === "egg") return "images/egg.png";
    if(stage === "chick") return "images/chick.png";
    if(stage === "rooster") return "images/rooster.png";
    if(stage === "phoenix") return "images/phoenix.png";
    return "images/egg.png";
  }

  /* ================= UI ================= */
  function updateUI(){
    document.getElementById("level").textContent = pet.level;
    document.getElementById("pet").src = getPetImage(pet.stage);

    // thermometer bars
    const bars = document.querySelectorAll("#thermometer .bar");
    if(bars.length){
      const active = Math.round(pet.hunger/10);
      bars.forEach((b,i)=> { if(i < active) b.classList.add("active"); else b.classList.remove("active"); });
    }

    // exp bar
    const expBar = document.getElementById("expBar");
    expBar.style.width = pet.exp + "%";
    expBar.textContent = "EXP " + Math.round(pet.exp) + "%";

    // coins & stocks
    document.getElementById("coinDisplay").textContent = "üí∞ " + (pet.coins || 0);
    document.getElementById("count-meat").textContent = foodStock.meat;
    document.getElementById("count-fruit").textContent = foodStock.fruit;
    document.getElementById("count-leaf").textContent = foodStock.leaf;

    // evo-ready control: disable feed on evo-level when exp >=100
    const isEvoLevel = (pet.level===10 && pet.stage==="egg") || (pet.level===20 && pet.stage==="chick") || (pet.level===30 && pet.stage==="rooster");
    if(isEvoLevel && pet.exp >= 100){
      document.getElementById("feedBtn").disabled = true;
      document.getElementById("evoBtn").style.display = "inline-block";
      document.getElementById("evoGlow").style.display = "block";
      startSparkle();
    } else {
      document.getElementById("feedBtn").disabled = false;
      if(pet.exp < 100){
        document.getElementById("evoBtn").style.display = "none";
        document.getElementById("evoGlow").style.display = "none";
      }
    }

    // plateFood preview
    if(selectedFood && foodStock[selectedFood] > 0){
      const plateFood = document.getElementById("plateFood");
      plateFood.src = "images/" + selectedFood + ".png";
      plateFood.style.display = "block";
    } else {
      document.getElementById("plateFood").style.display = "none";
    }

    // save
    localStorage.setItem("petData", JSON.stringify(pet));
    localStorage.setItem("foodStock", JSON.stringify(foodStock));
  }

  function showBubble(txt){
    const b = document.getElementById("bubble");
    b.textContent = txt;
    b.style.display = "block";
    setTimeout(()=> b.style.display = "none", 2200);
  }

  function playSound(id){
    const s = document.getElementById(id);
    if(s){ try{ s.currentTime = 0; s.play(); } catch(e){} }
  }

  /* ================= Feed / Evo ================= */
  function feedPet(){
    const isEvoLevel = (pet.level===10 && pet.stage==="egg") || (pet.level===20 && pet.stage==="chick") || (pet.level===30 && pet.stage==="rooster");
    if(isEvoLevel && pet.exp >= 100){
      showBubble("Sudah siap evolusi! Tekan tombol ‚ú®");
      return;
    }

    if(!selectedFood){ showBubble("Pilih makanan dulu!"); return; }
    if(foodStock[selectedFood] <= 0){ showBubble("Stok habis!"); return; }

    // consume
    foodStock[selectedFood]--;
    pet.hunger = Math.min(100, pet.hunger + 20);
    pet.coins = (pet.coins || 0) + 1;

    // exp
    let expGain = 0;
    if(selectedFood === "meat") expGain = 10;
    else if(selectedFood === "fruit") expGain = 5;
    else if(selectedFood === "leaf") expGain = 2.5;

    // floating text
    const foodDiv = document.querySelector(`.foodItem[data-food='${selectedFood}']`);
    if(foodDiv){
      const fly = document.createElement("span");
      fly.className = "flytext";
      fly.textContent = "+" + expGain + "% EXP";
      foodDiv.appendChild(fly);
      setTimeout(()=> fly.remove(), 1000);
    }

    playSound("soundFeed");

    // add exp with carryover (if not evo-ready)
    pet.exp = pet.exp + expGain;
    if(pet.exp >= 100){
      const evoReady = (pet.level===10 && pet.stage==="egg") || (pet.level===20 && pet.stage==="chick") || (pet.level===30 && pet.stage==="rooster");
      if(evoReady){
        pet.exp = 100; // cap so UI shows full
        document.getElementById("evoBtn").style.display = "inline-block";
        document.getElementById("evoGlow").style.display = "block";
        startSparkle();
        showBubble("EXP penuh ‚Äî tekan Evo Sekarang!");
      } else {
        // level up: carryover extra exp
        pet.exp = pet.exp - 100;
        pet.level++;
        playSound("soundLevel");
        showBubble("Level naik! Sekarang level " + pet.level);
      }
    } else {
      showBubble("Nyam nyam üçñ +" + expGain + "% EXP, +1 koin!");
    }

    if(foodStock[selectedFood] <= 0){
      selectedFood = null;
      document.getElementById("plateFood").style.display = "none";
    }
    updateUI();
  }

  function evolvePet(){
    const petImg = document.getElementById("pet");
    const oldStage = pet.stage;
    petImg.classList.add("evo-pulse");
    setTimeout(()=>{
      if(pet.level === 10 && oldStage === "egg"){ pet.stage = "chick"; pet.coins += 50; showBubble("‚ú® Evolusi jadi Anak Ayam üê• +50 koin!"); }
      else if(pet.level === 20 && oldStage === "chick"){ pet.stage = "rooster"; pet.coins += 50; showBubble("‚ú® Evolusi jadi Ayam Jantan üêì +50 koin!"); }
      else if(pet.level === 30 && oldStage === "rooster"){ pet.stage = "phoenix"; pet.coins += 50; showBubble("üî• Evolusi jadi Phoenix! +50 koin!"); }
      pet.exp = 0;
      document.getElementById("evoBtn").style.display = "none";
      document.getElementById("evoGlow").style.display = "none";
      petImg.src = getPetImage(pet.stage);
      petImg.classList.remove("evo-pulse");
      playSound("soundEvo");
      updateUI();
    }, 800);
  }

  function startSparkle(){
    const wrapper = document.getElementById("petWrapper");
    for(let i=0;i<10;i++){
      setTimeout(()=>{
        const s = document.createElement("span");
        s.className = "sparkle";
        const w = wrapper.clientWidth, h = wrapper.clientHeight;
        const x = (w/2) + (Math.random()*(w*0.6)-(w*0.3));
        const y = (h/2) + (Math.random()*(h*0.6)-(h*0.3));
        s.style.left = x + "px";
        s.style.top  = y + "px";
        wrapper.appendChild(s);
        setTimeout(()=> s.remove(), 1500);
      }, i*120);
    }
  }

  /* ================= Hunger timer & persist ================= */
  setInterval(()=>{
    pet.hunger = Math.max(0, pet.hunger - 5);
    if(pet.hunger < 50 && Math.random() < 0.25){
      showBubble("Aku lapar ü•∫");
      const p = document.getElementById("pet");
      p.classList.add("hungry");
      setTimeout(()=> p.classList.remove("hungry"), 800);
    }
    updateUI();
  }, 5000);

  function resetGame(){
    localStorage.removeItem("petData");
    localStorage.removeItem("foodStock");
    pet = { level:1, exp:0, stage:"egg", hunger:30, coins:0 };
    foodStock = { meat:100, fruit:100, leaf:100 };
    selectedFood = null;
    document.getElementById("plateFood").style.display = "none";
    updateUI();
    alert("Game direset! Pet kamu lapar ü•∫");
  }

  /* ================= Drag logic (touch + mouse) ================= */
  function createDragClone(x,y,foodType){
    // remove old clone if exists
    const old = document.getElementById("dragClone");
    if(old) old.remove();

    const img = document.createElement("img");
    img.id = "dragClone";
    img.src = "images/" + foodType + ".png";
    img.style.position = "fixed";
    img.style.left = (x - 30) + "px";
    img.style.top  = (y - 30) + "px";
    img.style.width = "60px";
    img.style.opacity = "0.9";
    img.style.zIndex = 9999;
    img.draggable = false;
    document.body.appendChild(img);
  }

  function moveClone(x,y){
    const clone = document.getElementById("dragClone");
    if(clone){
      clone.style.left = (x - 30) + "px";
      clone.style.top  = (y - 30) + "px";
    }
  }

  function removeClone(){
    const clone = document.getElementById("dragClone");
    if(clone) clone.remove();
  }

  function finishDrag(x,y,foodType){
    const plate = document.getElementById("plateWrapper").getBoundingClientRect();
    const centerX = plate.left + plate.width/2;
    const centerY = plate.top + plate.height/2 - 15;
    const dx = x - centerX;
    const dy = y - centerY;
    const dist = Math.sqrt(dx*dx + dy*dy);
    const radius = plate.width * 0.4;
    if(dist <= radius){
      if(foodStock[foodType] > 0){
        selectedFood = foodType;
        document.getElementById("plateFood").src = "images/" + foodType + ".png";
        document.getElementById("plateFood").style.display = "block";
        showBubble("üçΩÔ∏è " + foodType + " siap di piring!");
      } else {
        showBubble("Stok habis!");
      }
    }
    removeClone();
  }

  // touchstart handler
  function startDrag(ev, foodType){
    ev.preventDefault();
    const t = ev.touches[0];
    createDragClone(t.clientX, t.clientY, foodType);
    function onTouchMove(e){ moveClone(e.touches[0].clientX, e.touches[0].clientY); }
    function onTouchEnd(e){
      const ct = e.changedTouches[0];
      finishDrag(ct.clientX, ct.clientY, foodType);
      document.removeEventListener("touchmove", onTouchMove);
      document.removeEventListener("touchend", onTouchEnd);
    }
    document.addEventListener("touchmove", onTouchMove, {passive:false});
    document.addEventListener("touchend", onTouchEnd);
  }

  // mousedown handler for mouse
  function startDragMouse(ev, foodType){
    ev.preventDefault();
    createDragClone(ev.clientX, ev.clientY, foodType);
    function onMouseMove(e){ moveClone(e.clientX, e.clientY); }
    function onMouseUp(e){
      finishDrag(e.clientX, e.clientY, foodType);
      document.removeEventListener("mousemove", onMouseMove);
      document.removeEventListener("mouseup", onMouseUp);
    }
    document.addEventListener("mousemove", onMouseMove);
    document.addEventListener("mouseup", onMouseUp);
  }

  /* ================= Shop ================= */
  function toggleShop(show){
    document.getElementById("shopPopup").style.display = show ? "block" : "none";
  }
  function buyItem(type, price){
    if((pet.coins || 0) < price){ showBubble("Koin tidak cukup!"); return; }
    pet.coins -= price;
    foodStock[type] = (foodStock[type] || 0) + 1;
    playSound("soundCoin");
    showBubble("Berhasil beli " + type + "! +1 stok");
    updateUI();
  }
  // close shop when click outside
  document.addEventListener('click', (e)=>{
    const shop = document.getElementById("shopPopup");
    const btn = document.getElementById("shopBtn");
    if(!shop) return;
    if(shop.style.display === "block" && !shop.contains(e.target) && e.target !== btn){
      toggleShop(false);
    }
  });

  /* ================= Battle (socket.io client) ================= */
  function openBattleChoice(){ document.getElementById("battlePopup").style.display = "block"; }
  function closeBattle(){ document.getElementById("battlePopup").style.display = "none"; }
  function chooseHost(){
    arenaId = document.getElementById("arenaInput").value || "arena1";
    document.getElementById("battlePopup").style.display = "none";
    document.getElementById("hostPopup").style.display = "block";
  }
  function closeHost(){ document.getElementById("hostPopup").style.display = "none"; }
  function chooseClient(){
    arenaId = document.getElementById("arenaInput").value || "arena1";
    const ip = prompt("Masukkan IP Host (contoh: 192.168.43.1:3000)");
    if(ip){ connectToServer("http://" + ip); closeBattle(); }
  }
  function connectAsHost(){
    arenaId = document.getElementById("arenaInput").value || "arena1";
    // default local hotspot IP ‚Äî ganti sesuai host
    connectToServer("http://192.168.43.1:3000");
    closeHost();
  }

  function connectToServer(url){
    try {
      socket = io(url, { transports:['websocket'] });
    } catch(err){
      showBubble("Gagal inisialisasi socket");
      return;
    }

    socket.on("connect", ()=>{
      showBubble("Terhubung ke " + url);
      socket.emit("joinArena", arenaId, { id: socket.id, pet });
    });

    socket.on("joinedArena", (data) => {
      document.getElementById("log").textContent = "Masuk ke " + data.arenaId;
    });

    socket.on("roomFull", () => {
      alert("Arena penuh! Pilih ID lain.");
      if(socket){ socket.disconnect(); socket = null; }
    });

    socket.on("battleStart", (data) => {
      // start battle when server says both joined
      openArena();
      document.getElementById("log").textContent = "‚öîÔ∏è Battle dimulai di " + (data.arenaId||arenaId);
    });

    socket.on("playerJoined", (payload) => {
      document.getElementById("log").textContent = "üë• Musuh masuk arena!";
      if(payload && payload.pet && payload.pet.stage){
        document.getElementById("arenaEnemyPet").src = getPetImage(payload.pet.stage);
      }
    });

    socket.on("playerLeft", () => {
      document.getElementById("log").textContent = "‚ùå Musuh keluar!";
    });

    socket.on("action", (payload) => {
      if(payload && payload.action){
        document.getElementById("log").textContent = "Musuh melakukan: " + payload.action;
        if(payload.action === "attack") flashEnemy();
      }
    });

    socket.on("disconnect", () => {
      showBubble("Koneksi battle terputus");
      exitArena();
    });

    socket.on("connect_error", (err) => {
      console.warn(err);
      showBubble("Gagal connect ke server");
    });
  }

  function openArena(){
    document.getElementById("arenaMyPet").src = getPetImage(pet.stage);
    document.getElementById("arenaEnemyPet").src = "images/egg.png";
    document.getElementById("myHP").textContent = "HP: 100";
    document.getElementById("enemyHP").textContent = "HP: 100";
    document.getElementById("arena").style.display = "block";
  }

  function flashEnemy(){
    const el = document.getElementById("arenaEnemyPet");
    el.style.transform = "scale(0.92)";
    setTimeout(()=> el.style.transform = "", 160);
  }

  function exitArena(){
    document.getElementById("arena").style.display = "none";
    if(socket){
      try{ socket.emit('leaveArena', arenaId, { id: socket.id }); }catch(e){}
      try{ socket.disconnect(); }catch(e){}
    }
    socket = null;
  }

  function sendAction(action){
    if(!socket){ showBubble("Belum terhubung ke server"); return; }
    socket.emit("action", arenaId, { action });
    document.getElementById("log").textContent = "Kamu melakukan: " + action;
    if(action === "attack"){
      const el = document.getElementById("arenaMyPet");
      el.style.transform = "scale(0.92)";
      setTimeout(()=> el.style.transform = "", 160);
    }
  }

  /* ================ Init ================ */
  updateUI();
  </script>
</body>
</html>
