<!DOCTYPE html>
<html>
<head>

  <title>Game Pet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 
  <style>

  /* === PATCH BACKGROUND RESPONSIF (khusus file background.png 1280x989) === */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  overflow-x: auto;   /* scroll kanan‚Äìkiri aktif */
  overflow-y: hidden; /* tidak perlu scroll atas‚Äìbawah */
    /* üåà Gradasi langit ‚Üí tanah */
  background: linear-gradient(
    to bottom,
    #1e97d8 0%,     /* biru langit atas */
    #5cc3ff 40%,    /* biru muda awan */
    #5ca93d 80%,    /* hijau rumput terang */
    #2f7a2f 100%    /* hijau tua dasar */
  );


  /* üé® Font utama */
  font-family: sans-serif;
  font-weight: bold;
  color: #fff;

  /* üñ§ Outline hitam biar jelas di semua background */
  text-shadow:
  -0.7px -0.8px 0 #000,
   0.7px -0.8px 0 #000,
  -0.7px  0.8px 0 #000,
   0.7px  0.8px 0 #000;

  }

    /* === Reset font untuk bubble dan mini-bubble === */
#bubble,
.mini-bubble {
  font-family: sans-serif !important; /* kembali ke default sistem (seperti Roboto di Android) */
  font-weight: normal !important;
  font-style: normal !important;
  color: #fff;
  -webkit-text-stroke: 0 !important; /* hapus outline */
  text-shadow: none !important;       /* hilangkan shadow */
}

  h2 { margin-top:10px; font-size:6vw; }

 /* CSS (same as before) */
 /* ===== TOP BAR ===== */
#topBar {
  position: fixed;
  top: 5px;
  left: 5px;
  right: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
}

/* Susunan ikon kiri dan kanan */
#leftIcons, #rightIcons {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* Semua ikon utama */
/* ===== Restore Shop look & make other icons match it ===== */

/* Pastikan shop & coin kembali ke gaya semula */
#shopIcon, #coinDisplay {
  font-size: 4.5vw;                 /* ukuran ideal */
  background: rgba(0,0,0,0.3);      /* sama dengan awal */
  padding: 4px 8px;                 /* padding yang pas */
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  min-width: unset;                 /* batalkan min-width yang memaksa */
  min-height: unset;
  box-shadow: none;
  transform: none !important;       /* hapus efek transform bila ada */
}

/* Buat ikon kanan lain persis sama seperti shop (tanpa memaksa ukuran) */
#statsIcon, #emailIcon, #resetBtn, #logoutBtn {
  font-size: 4.5vw;
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  min-width: unset;     /* jangan paksa lebar/tinggi */
  min-height: unset;
  box-shadow: none;
  transform: none;
}

/* Reset aturan global yang mungkin tersisa untuk semua anak */
#leftIcons * , #rightIcons * {
  min-width: unset !important;
  min-height: unset !important;
}

/* Hover/active efek ringan yang aman */
#shopIcon:hover, #statsIcon:hover, #emailIcon:hover, #resetBtn:hover, #logoutBtn:hover {
  background: rgba(255,255,255,0.12);
}
#shopIcon:active, #statsIcon:active, #emailIcon:active, #resetBtn:active, #logoutBtn:active {
  transform: scale(1.06);
}

/* Supaya area klik tetap besar di HP */
#statsIcon, #emailIcon, #resetBtn, #logoutBtn {
  min-width: 10px;
  min-height: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

  #coinDisplay, #shopIcon, #statsIcon, #emailIcon {
    font-size:4.5vw;
    background:rgba(0,0,0,0.3);
    padding:4px 8px;
    border-radius:6px;
    cursor:pointer;
  }

  #resetWrapper {
  margin-left:5px;
  margin-top:30px;   /* ‚úÖ geser agak kebawah */
  }


  /* ===== BATTLE ICON ===== */
  #battleIcon {
    position:fixed;
    bottom:20%; right:10px;
    font-size:6vw;
    background:rgba(0,0,0,0.3);
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
    z-index:15;
  }
  /* Popup Shop */
  #shopPopup {
    display:none; position:fixed; top:50px; left:10px;
    background:rgba(51,51,51,0.9); padding:15px;
    border-radius:12px; z-index:20;
    text-align:left; width:160px;
  }

  #shopPopup h3 { margin:0 0 10px; font-size:4vw; }
  .shopItem { margin:10px 0; }
  .shopItem button { padding:6px 12px; font-size:3.5vw; }
  /* Popup Stats */
  #statsPopup {
    display:none; position:fixed; top:60px; right:10px;
    background:rgba(51,51,51,0.95); padding:15px;
    border-radius:12px; z-index:30;
    text-align:center; width:220px; font-size: 3.2vw;
  }

  #statsPopup h3 { margin-top:0; font-size:4vw; }
  #statButtons button { margin:3px; font-size:3.2vw; }


#centerIcons {
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

#infoIcon {
  font-size: 4.5vw;
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
}

#infoIcon:hover {
  background: rgba(255,255,255,0.12);
}
#infoIcon:active {
  transform: scale(1.06);
}


/* üåü Bubble utama (ucapan pet, lapar, evolusi) */
/* üí¨ Bubble teks di kanan pet */
/* === Bubble teks sejajar pet === */

#bubble {
  position: fixed;                /* fix terhadap layar, bukan pet-wrapper */
  top: 50%;
  left: calc(50% + 12vw);         /* sedikit di kanan pet */
  transform: translateY(-50%);
  background: rgba(255,255,255,0.9);
  border-radius: 10px;
  padding: 8px 12px;
  color: black;
  font-size: 1.2rem;
  max-width: 36vw;
  word-wrap: break-word;
  overflow-wrap: break-word;
  z-index: 200;
  display: none;
  transition: opacity 3s ease;
}

/* üì± versi HP: lebih dekat dan font menyesuaikan */
@media (max-width: 480px) {
  #bubble {
    left: 62%;
    max-width: 40vw;
    font-size: 3.6vw;
  }
}



/* üí∞üìä Mini bubble (coin/stat gain) */
.mini-bubble {
  position: fixed;
  background: rgba(255, 255, 200, 0.95);
  color: #0044cc;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 3vw;
  opacity: 0;
  z-index: 200;
  pointer-events: none;
  transform: scale(0.8);
  animation: miniPopFloat 2s ease-out forwards;
  will-change: transform, opacity;
}
@keyframes miniPopFloat {
  0%   { transform: scale(0); opacity: 0; }
  15%  { transform: scale(1.05); opacity: 1; }
  80%  { transform: translateY(-18px) scale(1); opacity: 1; }
  100% { transform: translateY(-25px) scale(0.9); opacity: 0; }
}

/* üí´ Sparkle & efek ringan */
.sparkle {
  position: absolute;
  width: 8px; height: 8px;
  background: white;
  border-radius: 50%;
  opacity: 0.8;
  animation: sparkleMove 1.2s forwards;
  pointer-events: none;
  z-index: 2;
  will-change: transform, opacity;
}
@keyframes sparkleMove {
  0%   { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-40px) scale(0.5); opacity: 0; }
}



    .thermometer { display:flex; 
                  flex-direction:column-reverse;
                  justify-content:flex-start;
                  width:30px;
                  height:220px;
                  border:2px
                  solid #ccc;
                  border-radius:6px;
                  overflow:hidden;
                  background:#666;
                  position:relative;
                 }
    .bar { flex:1; margin:1px 0; background:#666; }
    .bar.active { opacity:1; }
    .bar:nth-child(2).active{background:#800000;}
    .bar:nth-child(3).active{background:#b22222;}
    .bar:nth-child(4).active{background:#ff4500;}
    .bar:nth-child(5).active{background:#ff8c00;}
    .bar:nth-child(6).active{background:#ffd700;}
    .bar:nth-child(7).active{background:#f0e68c;}
    .bar:nth-child(8).active{background:#adff2f;}
    .bar:nth-child(9).active{background:#7fff00;}
    .bar:nth-child(10).active{background:#32cd32;}
    .bar:nth-child(11).active{background:#00ff00;}
    .thermo-label { position:absolute; left:10%; transform:translateX(-10%); font-size:2vw; color:white;

    text-shadow:1px 1px 2px black;
    white-space: nowrap;
    }


    #labelTop { top:1px; } #labelBottom { bottom:1px; }
  
    
    
    

.hungry { }
    @keyframes evoPulse { 0%,100% { transform: scale(1);} 25%{transform:scale(1.3);} 50%{transform:scale(0.7);} 75%{transform:scale(1.4);} }
    @keyframes evoPop { 0%{transform:scale(0);opacity:0;} 80%{transform:scale(1.2);opacity:1;} 100%{transform:scale(1);} }
    .evo-pulse { animation:evoPulse 2s ease-in-out; }
    .evo-pop   { animation:evoPop 0.8s ease-out; }

.flytext {
  position: absolute;
  left: 50%;
  bottom: 5px;
  transform: translateX(-50%) translateY(0);
  font-size: 3.2vw;
  color: #ffeb3b;
  text-shadow: 1px 1px 3px black;
  opacity: 0;
  animation: flyUp 1s ease-out forwards;
  pointer-events: none;
  z-index: 50;
}



    
.bar {
  transition: background 0.3s ease, opacity 0.3s ease;
}
.thermo-label {
  pointer-events: none;
}

#gameContainer {
  position: relative;
  width: 160vw;       /* dunia lebih lebar dari layar */
  height: 100vh;      /* penuh tinggi layar */
  overflow: visible;
  z-index: 0;
}


/* === Layout & Spacing Scale Adjustment === */
/* Ruang kosong antar bagian utama */
#gameContent {
  width: 540px;
  height: 960px;
  transform: scale(var(--scale));
  transform-origin: top left;
  position: relative;
  overflow: visible;
  background: none;
  padding-bottom: 6vh !important;
}
  /* Pet wrapper */
/* === Fix posisi Pet & Thermometer di semua layar === */
.pet-wrapper {
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);  /* ‚¨ÖÔ∏è sejajarkan benar-benar di tengah layar */
  display: flex;
  justify-content: center;
  align-items: center;
  width: auto;
  height: auto;
  margin: 0;
  padding: 0;
  overflow: visible;
  z-index: 5;
}


.thermometer {
  position: fixed;
  top: 40%;
  left: 5vw;                          /* mepet kiri layar */
  transform: translateY(-50%);        /* sejajar tengah vertikal */
  z-index: 6;
}

#pet {
  position: relative;           /* tetap relative untuk rotasi 3D */
  width: 50vw;
  max-width: 220px;
  height: auto;
  transform-style: preserve-3d; /* agar bisa diputar 3D */
  z-index: 2;
  filter: drop-shadow(8px 12px 8px rgba(0,0,0,0.5));
  will-change: transform;
}



#pet, .mini-bubble, .flytext {
  will-change: transform, opacity;
}


/* üåü Efek evolusi di tengah pet */
#evoGlow {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 140%;
  height: 140%;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,255,0,0.6), rgba(255,255,0,0.1) 70%);
  filter: blur(25px);
  z-index: 1; /* di belakang pet */
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.6s ease;
}
#evoGlow.active {
  opacity: 1;
  animation: pulseGlow 1.2s infinite alternate ease-in-out;
}
@keyframes pulseGlow {
  from { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
  to   { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
}




    
/* üßæ Info text di bawah pet */
#gameContent p {
  margin: 6px 0;
  line-height: 1.4em;
}

/* üéÆ Tombol utama */
#feedBtn, #playBtn, #evoBtn {
  margin: 10px 6px;
  font-size: 3.8vw;
  padding: 8px 16px;
  border-radius: 10px;
  box-shadow: 0 3px 5px rgba(0,0,0,0.3);
  margin-top: 4px !important;
}


/* === Slot kotak makanan === */
.slot {
  width: 12vw;                 /* lebar relatif layar */
  aspect-ratio: 1 / 1;         /* tinggi otomatis sama dengan lebar */
  border: 0.3vw solid #999;
  border-radius: 1vw;
  background: rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;          /* üü¢ penting untuk posisi flytext */
  overflow: visible;           /* üü¢ biar teks terbang terlihat */
  transition: transform 0.2s ease;
  cursor: pointer;
}

/* Slot kosong */
.slot.empty {
  background: rgba(255,255,255,0.05);
  border: 0.3vw dashed #666;
}

/* Slot disabled (stok habis) */
.slot.disabled {
  opacity: 0.4;
  filter: grayscale(80%);
  pointer-events: none;
}

/* === Gambar item di dalam slot === */
.slot img {
  width: 80%;
  height: 80%;
  object-fit: contain;
}

/* Jumlah stok di pojok kanan bawah */
.slot .count {
  position: absolute;
  bottom: 3px;
  right: 5px;
  color: red;
  font-weight: bold;
  font-size: 3vw;
  text-shadow: 1px 1px 2px black;
}

/* ‚ú® Efek teks melayang saat feed (+EXP, dll) */
.flytext {
  position: absolute;
  left: 50%;
  bottom: 8px; /* mulai dari bawah slot */
  transform: translateX(-50%) translateY(0);
  font-size: 3.2vw;
  color: #ffeb3b; /* kuning cerah */
  text-shadow: 1px 1px 3px black;
  opacity: 0;
  animation: flyUp 3s ease-out forwards;
  pointer-events: none;
  z-index: 50;
}

@keyframes flyUp {
  0%   { transform: translateX(-50%) translateY(0); opacity: 1; }
  100% { transform: translateX(-50%) translateY(-30px); opacity: 0; }
}

/* === Fly text untuk hasil Battle === */
.flytext-battle {
  position: fixed;
  font-size: 5vw;
  font-weight: bold;
  text-shadow: 2px 2px 5px black;
  opacity: 0;
  z-index: 9999;
  pointer-events: none;
  animation: flyBattleUp 1.2s ease-out forwards;
}

@keyframes flyBattleUp {
  0%   { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
  70%  { transform: translate(-50%, -70%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -90%) scale(1.3); opacity: 0; }
}

    

/* === PATCH POSISI & TATA LETAK 2025-10 === */

/* üí´ Glow evolusi lebih terlihat (di atas pet tapi di bawah bubble) */
#evoGlow {
  z-index: 5 !important;
}

/* üß© Tambahkan ruang bawah agar tombol tidak tertutup battleIcon */
#gameContent {
  padding-bottom: 2vh; /* ruang aman untuk feed/play/evo */
}

/* üê£ Perhalus peralihan animasi agar tidak freeze */
#pet.idle {
  animation: idleMotion 4.5s ease-in-out infinite !important;
}
#pet.hungry {
  animation: hungry-shake 0.6s infinite !important;
}

/* üîò Perbaiki resetBtn agar konsisten */
#resetBtn {
  position: relative;
  margin-top: 0 !important;
  opacity: 0.8 !important;
}
#resetWrapper {
  position: fixed;
  top: 5px;
  right: 5px;
  z-index: 10;
}

/* ‚öîÔ∏è Pastikan semua popup selalu di atas background */
#shopPopup, #statsPopup, #battlePopup, #loginBox, #logoutPopup {
  z-index: 100 !important;
}
#logoutPopup { z-index: 300 !important; }


/* üõí Popup hanya satu yang boleh aktif: auto-hide lainnya */
#shopPopup:has(~ #statsPopup[style*="display:block"]),
#shopPopup:has(~ #battlePopup[style*="display:block"]),
#statsPopup:has(~ #shopPopup[style*="display:block"]) {
  display: none !important;
}
/* === PATCH: Kompres tampilan Stats Popup agar pas di layar === */
#statsPopup {
  max-height: 82vh;          /* batasi tinggi popup agar muat di HP */
  overflow-y: auto;           /* gulir vertikal jika melebihi layar */
  padding: 10px 12px !important;
  line-height: 1.2em;
}

#statsPopup h3 {
  margin-top: 0;
  margin-bottom: 4px;
  font-size: 4vw;
}

#statsPopup p {
  margin: 4px 0;
  font-size: 3.4vw;
}
/* masukkan ini setelah definisi #statsPopup (di bagian PATCH stats) */
#statsPopup.active {
  opacity: 1 !important;
  transform: translateY(0) !important;
  pointer-events: auto !important;
}

/* Baris tiap stat lebih rapat tapi tetap mudah disentuh */
#statButtons div {
  margin: 2px 0 !important;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Tombol + lebih kecil dan rata kanan */
#statButtons button {
  font-size: 3.2vw;
  padding: 2px 6px;
  margin-left: 6px;
}

/* Total Power tampil lebih ringkas */
#popupTotalPower {
  font-weight: bold;
  color: #ffeb3b;
}

/* Tombol Tutup tetap terlihat jelas di bawah */
#statsPopup button:last-child {
  margin-top: 6px;
  font-size: 3.5vw;
  padding: 6px 12px;
}

/* === Efek lembut untuk semua popup utama === */
#statsPopup, #shopPopup, #battlePopup {
  opacity: 0;
  transform: translateY(-10px);
  transition: opacity 0.35s ease, transform 0.35s ease;
}

/* === Posisi Battle Popup agar tampil di tengah layar === */
#battlePopup {
  left: 50% !important;
  top: 50% !important;
  right: auto !important;
  transform: translate(-50%, -50%) !important;
  margin: 0 !important;
  padding: 10px 15px !important;
  width: 240px; /* sesuaikan lebar */
  text-align: center;
}


/* üéÆ Tombol aksi bawah (Feed, Play, Evo) */
/* üéÅ Grid makanan di atas rumput */
#foodGrid {
  position: fixed;
  bottom: 7vh;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 1.5vw;
  z-index: 10;
}

/* üçΩÔ∏è Piring di atas grid */
/* === Piring dinamis: membesar sesuai ukuran layar === */
#plateWrapper {
  position: fixed;
  bottom: calc(7vh + 20vw);
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 5;
  pointer-events: auto;
  width: 35vw;           /* relatif terhadap lebar layar */
  height: 20vw;
  max-width: 320px;      /* batas maksimum di HP kecil */
  max-height: 200px;
  overflow: visible;
}

#plate {
  width: 100%;
  height: auto;
}

#plateFood {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 65%;
  height: 65%;
  object-fit: contain;
  display: none;
}

/* üíª Mode desktop: sedikit diperbesar */
@media (min-width: 900px) {
  #plateWrapper {
    width: 40vw;
    height: 24vw;
    bottom: calc(8vh + 14vw); /* naik sedikit supaya pas */
  }

  #plateFood {
    width: 70%;
    height: 70%;
  }
}


/* üéÆ Tombol Feed / Play / Evo di atas piring */
#bottomButtons {
  position: fixed;
  bottom: calc(7vh + 40vw); /* dinaikkan sedikit */
  left: 0;
  width: 100%;
  display: flex;
  justify-content: center;
  gap: 4vw;
  z-index: 6;
}

/* === PANEL INFO PET (ATAS TENGAH) === */
#petInfoPanel {
  position: fixed;
  top: 12vh;               /* jarak dari atas layar */
  left: 50%;
  transform: translateX(-50%);
  z-index: 8;
  display: none;
  background: rgba(0, 0, 0, 0.4);
  color: #fff;
  padding: 6px 12px;
  border-radius: 12px;
  text-align: center;
  font-size: 3.5vw;
  backdrop-filter: blur(3px);
}

/* üì± Mode layar kecil (HP portrait) */
@media (max-width: 600px) {
  #petInfoPanel {
    top: 8vh;              /* lebih dekat ke atas di HP */
    font-size: 4vw;
    padding: 4px 10px;
  }
}

/* üíª Mode desktop (lebar) */
@media (min-width: 900px) {
  #petInfoPanel {
    top: 10vh;
    font-size: 2vw;
  }
}







/* Reset default margin tombol global untuk area bawah */
#bottomButtons button {
  margin: 0;                /* hilangkan margin global */
  background: linear-gradient(180deg, #ffb347, #ff7733);
  border: none;
  border-radius: 1vw;
  padding: 1.2vh 4vw;
  font-size: 3.5vw;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 3px 6px rgba(0,0,0,0.4);
  cursor: pointer;
  transition: transform 0.2s;
}

#bottomButtons button:active {
  transform: scale(0.95);
}

/* üìä EXP bar dan pet level */
/* === Tampilan EXP Bar === */
#expBarContainer {
  position: fixed;
  bottom: calc(7vh + 50vw);
  left: 50%;
  transform: translateX(-50%);
  z-index: 30;
  text-align: center; /* üí° ini kuncinya */
  top: auto;
}
/* Teks Level */
#petLevel {
  position: relative;
  top: -3.5vh; /* geser naik sedikit agar tepat di atas bar */
  font-size: 4vw;
  color: #ffeb3b;
  text-shadow: 2px 2px 4px black;
  font-weight: bold;
  text-align: center;
  width: 100%; /* pastikan sejajar dengan bar-container */
}

.bar-container {
  position: relative;
  width: 70vw;
  max-width: 500px;
  height: 18px;
  margin: 0 auto;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  background: #e0e0e0;
  overflow: hidden;
  box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.8);
}

/* üü¶ Bar biru bergerak */
#expFill {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  width: 0%; /* akan diubah lewat JS */
  background-color: #1976d2;
  transition: width 1.8s ease;
  z-index: 1; /* di bawah overlay */
}

/* üß≠ Lapisan statis berisi garis & teks */
#expOverlay {
  position: absolute;
  inset: 0;
  z-index: 2;
  pointer-events: none; /* biar klik tidak terblokir */
}

/* üìè Garis penggaris tetap diam */
 /* Garis pendek 5% (setengah tinggi) */
#expMarksShort {
  position: absolute;
  inset: 0;
  background:
    repeating-linear-gradient(
      90deg,
      transparent 0%,
      transparent 4.5%,
      rgba(255,255,255,0.7) 4.5%,
      rgba(255,255,255,0.7) 5%,
      transparent 5%
    );
  mask-image: linear-gradient(to bottom, black 0 50%, transparent 50% 100%);
  mask-repeat: no-repeat;
  mask-size: 100% 100%;
  background-repeat: repeat-x;
  z-index: 2;
}

/* Garis panjang 10% (penuh tinggi) */
#expMarksLong {
  position: absolute;
  inset: 0;
  background:
    repeating-linear-gradient(
      90deg,
      transparent 0%,
      transparent 9.5%,
      rgba(255,255,255,1) 9.5%,
      rgba(255,255,255,1) 10%,
      transparent 10%
    );
  background-repeat: repeat-x;
  z-index: 1;
}

/* Teks di tengah */
#expText {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  color: #fff;
  font-weight: bold;
  font-size: 12px;
  line-height: 24px;
  text-shadow: 1px 1px 2px black;
  z-index: 3;
}

  

  


/* ‚ú® Teks di tengah bar */
#expText {
  position: absolute;
  top: 0;
  left: 50%;
  transform: translateX(-50%);
  font-size: 12px;
  line-height: 18px;
  color: #fff;
  font-weight: bold;
  text-shadow: 1px 1px 2px black;
}






/* üî∏ Tombol utama bawah (Feed, Play, Evo) */
.mainBtn {
  background: linear-gradient(180deg, #ffb347, #ff7733);
  border: none;
  border-radius: 1vw;
  padding: 1.2vh 4vw;
  font-size: 3.5vw;
  color: #fff;
  font-weight: bold;
  box-shadow: 0 3px 6px rgba(0,0,0,0.4);
  cursor: pointer;
  transition: transform 0.2s;
}
.mainBtn:active {
  transform: scale(0.95);
}
.mainBtn:disabled {
  opacity: 0.5;
  background: #777;
  cursor: not-allowed;
}

/* üîπ Tombol popup (OK, Close, Shop, Battle, dll) */
.popupBtn {
  background: #666;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-size: 3vw;
  cursor: pointer;
  transition: background 0.2s;
}
.popupBtn:hover {
  background: #888;
}
/* =========================== */
/* === BACKGROUND SCENE FIX === */
/* =========================== */
/* === BACKGROUND TANPA STRETCH, RASIO ASLI 1280x989 === */
/* === BACKGROUND FULL-SCREEN TANPA TERPOTONG, MASIH BISA SCROLL === */
#background {
  position: relative;                         /* penting: biar ikut scroll */
  width: 160vw;                               /* sama seperti lebar dunia */
  height: auto;                               /* biarkan proporsional */
  aspect-ratio: 1280 / 989;                   /* sesuai rasio aslinya */
  background-image: url("./images/background.png");
  background-repeat: repeat-x;
  background-size: contain;                   /* ‚ö° tampil proporsional */
  background-position: bottom center;         /* jaga bagian bawah tetap di bawah */
  z-index: 0;
}

/* === Mode layar lebar (desktop / landscape) === */
@media (min-aspect-ratio: 16/9) {
  #background {
    width: 180vw;
    
  }
}

/* === Mode layar tinggi (HP portrait) === */
@media (max-aspect-ratio: 9/16) {
  #background {
    width: 150vw;

  }
}








/* ‚òÅÔ∏è Awan bergerak */
.cloud {
  position: absolute;
  top: 8vh;                       /* turun sedikit dari atas agar pas di langit */
  width: 22vw;                    /* lebar relatif layar */
  max-width: 220px;
  opacity: 0.85;
  animation: moveCloud 60s linear infinite;
  z-index: 2;
}
@keyframes moveCloud {
  from { left: -25vw; }
  to   { left: 100%; }
}

/* üå≥ Pohon di belakang pet dan piring */
.tree {
  position: fixed;
  bottom: 15vh;                   /* pas di atas rumput */
  width: 50vw;
  max-width: 320px;
  transform-origin: bottom center;
  animation: sway 4s ease-in-out infinite alternate;
  z-index: 2;
  opacity: 0.95;
}
@keyframes sway {
  from { transform: rotate(-2deg); }
  to   { transform: rotate(2deg); }
}

/* üåø Rumput di dasar scene */
/* === Animasi Rumput Hidup === */
.grass {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: auto;
  pointer-events: none;
  z-index: 2;
  background-colour: rgba(0,0,0,0.5);
  opacity: 0.95;
  height: 100px; /* Sesuaikan dengan tinggi gambar grass */
}




/* üåÖ Penyesuaian otomatis untuk berbagai rasio layar */
@media (max-aspect-ratio: 9/16) { /* layar tinggi (HP modern 20:9) */
  .cloud { top: 10vh; }
  .tree { bottom: 8vh; }
}
@media (min-aspect-ratio: 16/9) { /* layar lebar (tablet/desktop landscape) */
  .cloud { top: 6vh; }
  .tree { bottom: 9vh; }
}

   /* Animasi idle / napas lembut */
@keyframes idleMotion {
  0%,100% { transform: translateY(0) scale(1); }
  50%     { transform: translateY(-4px) scale(1.03); }
}
#pet.idle {
  animation: idleMotion 6s ease-in-out infinite;
}

/* Animasi hungry */
@keyframes hungry-shake {
  0%   { transform: translate(0,0) rotate(0deg); }
  10%  { transform: translate(-3px, -1px) rotate(-1deg); }
  20%  { transform: translate(3px, 2px) rotate(1deg); }
  30%  { transform: translate(-2px, 1px) rotate(-1deg); }
  40%  { transform: translate(2px, -1px) rotate(1deg); }
  50%  { transform: translate(-2px, 2px) rotate(-1deg); }
  60%  { transform: translate(1px, -1px) rotate(1deg); }
  70%  { transform: translate(-2px, 1px) rotate(-1deg); }
  80%  { transform: translate(2px, -2px) rotate(1deg); }
  90%  { transform: translate(-1px, 2px) rotate(-1deg); }
  100% { transform: translate(0,0) rotate(0deg); }
}
#pet.hungry {
  animation: hungry-shake 0.6s infinite;
}

/* Animasi lompat bermain */

/* === PET JUMP (versi ekspresif, 3 detik, lompat ke depan + rotasi 720¬∞) === */
@keyframes petJump {
  0% {
    transform: translate3d(0, 0, 0) rotate(0deg) scale(1);
  }
  10% {
    transform: translate3d(2vw, -5vh, 0) rotate(180deg) scale(1.05);
    animation-timing-function: cubic-bezier(0.3, 0.7, 0.5, 1);
  }
  25% {
    transform: translate3d(4vw, -9vh, 2vw) rotate(360deg) scale(1.1);
    animation-timing-function: ease-out;
  }
  50% {
    transform: translate3d(6vw, -6vh, 3vw) rotate(540deg) scale(1.07);
    animation-timing-function: ease-in-out;
  }
  70% {
    transform: translate3d(3vw, -3vh, 1vw) rotate(720deg) scale(1.03);
    animation-timing-function: ease-in;
  }
  90% {
    transform: translate3d(0, -1vh, 0) rotate(720deg) scale(1.02);
  }
  100% {
    transform: translate3d(0, 0, 0) rotate(720deg) scale(1);
  }
}

.pet-fly {
  animation: petJump 3s ease-in-out;
  will-change: transform;
  transform-origin: center bottom; /* agar rotasi terasa dari bawah tubuh */
}

    

/* Pastikan tombol disabled benar-benar tidak bisa diklik */
.mainBtn:disabled {
  opacity: 0.5;
  background: #777;
  cursor: not-allowed;
  pointer-events: none; /* ‚õî mencegah klik saat tunggu */
}

    

/* === BUBBLE TEXT LEMBUT (FADE OUT NATURAL) === */
#bubble.active {
  display: block;
  animation: bubbleSoftFade 3s ease-out forwards;
}

/* Muncul lembut, naik sedikit, lalu menghilang halus */
@keyframes bubbleSoftFade {
  0% {
    opacity: 0;
    transform: translateY(1vh) scale(0.96);
  }
  15% {
    opacity: 1;
    transform: translateY(-0.5vh) scale(1);
  }
  60% {
    opacity: 1;
    transform: translateY(-2vh) scale(1.02);
  }
  100% {
    opacity: 0;
    transform: translateY(-3.5vh) scale(1.04);
  }
}


 
    
  </style>
</head>
<body>


<!-- === LOADING SCREEN (SIMPLES) === -->
<div id="loadingScreen" style="
  position:fixed; top:0; left:0; width:100vw; height:100vh;
  background:#111; color:#fff; display:flex; flex-direction:column;
  justify-content:center; align-items:center; font-family:sans-serif;
  font-size:5vw; z-index:9999;">
  <div id="loadingText">Loading... 0%</div>
  <div style="margin-top:12px; width:60%; height:10px; background:#444; border-radius:5px; overflow:hidden;">
    <div id="loadingBar" style="width:0%; height:100%; background:#4caf50; transition:width 0.2s;"></div>
  </div>
</div>

  
  <!-- TOP BAR -->
  <div id="topBar">
    <div id="leftIcons">
      <div id="coinDisplay">üí∞ 0</div>
      <div id="shopIcon" onclick="toggleShop()">üõí</div>
    </div>
    <div id="centerIcons">
  <div id="infoIcon" onclick="toggleInfo()">‚ÑπÔ∏è</div>
</div>

    <div id="rightIcons">
  <div id="statsIcon" onclick="toggleStats()">üìä</div>
  <div id="emailIcon">üìß</div>
  <div id="resetBtn" onclick="resetGame()">üîÑ</div>
  <div id="logoutBtn" style="display:none;">üîì</div>
</div>

  </div>


  <!-- POPUP LOGIN EMAIL -->

  <div id="loginBox" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,0.85); padding:20px; border-radius:12px; color:white; z-index:100;">
    <h3>üîë Login dengan Email</h3>
    <input id="emailInput" type="email" placeholder="Masukkan email" style="padding:8px; font-size:3.5vw;">
    <button onclick="sendLoginLink()">Kirim Link OTP</button>
    <button onclick="document.getElementById('loginBox').style.display='none'">Tutup</button>
  </div>

<!-- Popup konfirmasi logout -->
<div id="logoutPopup"
  style="display:none; position:fixed; top:40%; left:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.85); padding:20px; border-radius:12px; color:white; z-index:300;">
  <p>Apakah yakin ingin logout?</p>
  <button onclick="confirmLogout()">‚úÖ Ya</button>
  <button onclick="cancelLogout()">‚ùå Batal</button>
</div>

  <!-- BATTLE ICON -->
  <div id="battleIcon" onclick="toggleBattle()">‚öîÔ∏è</div>

  <!-- Popup Shop -->
  <div id="shopPopup">
    <h3>Shop</h3>
    <div class="shopItem"><span>üçñ Daging - 10 koin</span><br><button onclick="buyItem('meat',10)">Beli</button></div>
    <div class="shopItem"><span>üçé Buah - 5 koin</span><br><button onclick="buyItem('fruit',5)">Beli</button></div>
    <div class="shopItem"><span>üåø Daun - 3 koin</span><br><button onclick="buyItem('leaf',3)">Beli</button></div>
    <button onclick="toggleShop()">Tutup</button>
  </div>

  <!-- Popup Stats -->
 <div id="statsPopup" style="display:none;
  position:fixed; top:60px; right:10px;
  background:rgba(51,51,51,0.95);
  padding:15px; border-radius:12px; z-index:30;
  text-align:center; width:220px; font-size:3.2vw;">

  <h3>Stats</h3>

  <!-- üî• Total Power di atas -->
  <p style="font-size:3.6vw; margin:4px 0 10px 0;">
    üî• Total Power: <span id="popupTotalPower">0</span>
  </p>

  <canvas id="statsChart" width="200" height="200"
    style="margin-bottom:8px;"></canvas>

  <p>Sisa Poin: <span id="statPoints">0</span></p>
  <div id="statButtons" style="margin-top:4px; margin-bottom:6px;"></div>
  <button onclick="toggleStats()">Tutup</button>
</div>


  <!-- Popup Battle -->
  <div id="battlePopup" style="display:none; position:fixed; top:60px; left:50%; transform:translateX(-50%);
    background:rgba(51,51,51,0.95); padding:15px; border-radius:12px; z-index:40;
    text-align:center; width:240px; font-size:3.2vw;">
<h3>‚öîÔ∏è Arena Battle</h3>

<p id="playerInfo">
  Pet: <span id="battlePetName">-</span><br>
  Power: ‚öîÔ∏è <span id="playerAtk">-</span> / üõ°Ô∏è <span id="playerDef">-</span><br>
  üî• Total: <span id="playerTotal">-</span>
</p>

    <p id="enemyInfo">
  Musuh Dummy<br>
  Power: ‚öîÔ∏è <span id="enemyAtk">-</span> / üõ°Ô∏è <span id="enemyDef">-</span><br>
  üî• Total: <span id="enemyTotal">-</span>
</p>

</p>

    <button onclick="startBattle()">Mulai</button>
    <button onclick="toggleBattle()">Tutup</button>
  </div>


<div id="expBarContainer">
  <div id="petLevel">Level 1</div>
  <div class="bar-container">
    <div id="expFill"></div>
    <div id="expOverlay">
       <div id="expMarksShort"></div> <!-- Garis 5% pendek -->
       <div id="expMarksLong"></div>  <!-- Garis 10% penuh -->
      <span id="expText">EXP 0%</span>
    </div>
  </div>
</div>

  
<div id="gameContainer">
  <div id="gameContent">

    <!-- üå§Ô∏è Background Layer -->
    <div id="background">
      <img src="images/cloud.png" class="cloud">
      <img src="images/tree.png" class="tree" style="left:5%; bottom:60px;">
      
    </div>

    <!-- üê£ Pet Area -->
    <div class="pet-wrapper" id="petWrapper">
      <div class="glow" id="evoGlow"></div>
      <img id="pet" src="images/egg.png">
    </div>
    
     <div class="thermometer" id="thermometer">
       <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div>
        <span class="thermo-label">0%</span>
        <div id="labelBottom" class="thermo-label" style="bottom:-1.5em;">Lapar</div>
      </div>
      
 <div id="bubble"></div>
    
    
    <!-- üßæ Info Panel -->

<!-- Info dinamis akan diisi oleh updateUI() -->
<div id="petInfoPanel" style="font-size:3.8vw; text-align:center;">
 <p>Level Pet: <span id="level">1</span></p>
  <div id="petName">üêæ Nama Pet: -</div>
  <div id="ownerName">üë§ Pemilik: -</div>
  <div id="petPowerAtk">‚öîÔ∏è Power Atk: -</div>
  <div id="petPowerDef">üõ°Ô∏è Power Def: -</div>
  <div id="petPowerTotal">üî• Total Power: -</div>

</div>

 





    <!-- üéÆ Tombol Aksi -->
<div id="bottomButtons">
  <button id="feedBtn" class="mainBtn">Feed üçñ</button>
  <button id="playBtn" class="mainBtn">üéÆ Play</button>
  <button id="evoBtn" class="mainBtn" style="display:none;">‚ú® Evo Sekarang!</button>
</div>


    <!-- üçΩÔ∏è Piring -->
    <div id="plateWrapper">
      <img id="plate" src="images/plate.png" alt="Piring">
      <img id="plateFood" src="" alt="">
    </div>

    <!-- üçñ Food Grid -->
    <div id="foodGrid">
      <div class="slot" data-food="meat">
        <img src="images/meat.png">
        <div class="count" id="count-meat">100</div>
      </div>
      <div class="slot" data-food="fruit">
        <img src="images/fruit.png">
        <div class="count" id="count-fruit">100</div>
      </div>
      <div class="slot" data-food="leaf">
        <img src="images/leaf.png">
        <div class="count" id="count-leaf">100</div>
      </div>
      <div class="slot empty"></div>
      <div class="slot empty"></div>
    </div>

  </div> <!-- end #gameContent -->
</div> <!-- end #gameContainer -->

<img src="images/grass.png" class="grass"
  
  <!-- Suara -->
  <audio id="sound" src="sounds/feed.mp3" preload="auto"></audio>
  <audio id="soundLevel" src="sounds/levelup.mp3" preload="auto"></audio>
  <audio id="soundEvo" src="sounds/evo.mp3" preload="auto"></audio>
  <audio id="soundBuy" src="sounds/buy.mp3" preload="auto"></audio>


  
  <script>
    // Klik ikon email untuk buka/tutup popup login
    document.getElementById("emailIcon").onclick = function(){
      const box = document.getElementById("loginBox");
      box.style.display = (box.style.display==="block" ? "none" : "block");
    };
  </script>

  <script>
// === SEMBUNYIKAN LOGOUT SAAT HALAMAN PERTAMA KALI DIMUAT ===
// Tujuannya agar tombol logout tidak muncul duluan sebelum Firebase selesai cek status.
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.style.display = "none";
});
</script>

<script>
const assetList = [
  "images/background.png",
  "images/grass.png",
  "images/cloud.png",
  "images/tree.png",
  "images/egg.png",
  "images/chick.png",
  "images/rooster.png",
  "images/phoenix.png",
  "images/fruit.png",
  "images/meat.png",
  "images/leaf.png",
  "images/plate.png",
  "sounds/feed.mp3",
  "sounds/levelup.mp3",
  "sounds/evo.mp3",
  "sounds/buy.mp3"
];

// === Fungsi preload profesional (versi rapi & aman) ===
function preloadAssets(list, onComplete) {
  let loaded = 0;
  const total = list.length;

  function updateProgress() {
    const percent = Math.round((loaded / total) * 100);
    const bar = document.getElementById("loadingBar");
    const text = document.getElementById("loadingText");
    if (bar) bar.style.width = percent + "%";
    if (text) text.innerText = "Loading... " + percent + "%";

    if (loaded >= total) {
      // Semua selesai
      setTimeout(() => {
        const loadDiv = document.getElementById("loadingScreen");
        if (loadDiv) {
          loadDiv.style.transition = "opacity 0.5s";
          loadDiv.style.opacity = "0";
          setTimeout(() => loadDiv.remove(), 500);
        }
        onComplete();
      }, 300);
    }
  }

  list.forEach(src => {
    const ext = src.split('.').pop().toLowerCase();
    let el;

    if (["png", "jpg", "jpeg", "webp", "gif"].includes(ext)) {
      el = new Image();
      el.onload = el.onerror = () => { loaded++; updateProgress(); };
      el.src = src;
    } 
    else if (["mp3", "ogg", "wav"].includes(ext)) {
      el = new Audio();
      el.src = src;
      // Audio sering tidak memicu onload, jadi langsung hitung selesai
      loaded++;
      updateProgress();
    } 
    else {
      // File lain seperti font atau json
      el = document.createElement("link");
      el.rel = "preload";
      el.href = src;
      el.onload = el.onerror = () => { loaded++; updateProgress(); };
      document.head.appendChild(el);
    }
  });
}

window.addEventListener("load", () => {
  preloadAssets(assetList, () => {
    console.log("‚úÖ Semua asset siap, game dimulai!");
    if (typeof updateUI === "function") updateUI();
  });
});
</script>


  
<!-- ==================== START: MAIN GAME LOGIC (keharusan diletakkan BEFORE Firebase SDK) ==================== -->
<script>

// === MUAT DATA PET DARI LOCALSTORAGE (FIXED ORDER) ===
let pet;
let foodStock;
let selectedFood = null;
let evoAnimating = false;

try {
  const storedPet = JSON.parse(localStorage.getItem("petData") || "null");
  const storedFood = JSON.parse(localStorage.getItem("foodStock") || "null");

  if (storedPet && typeof storedPet.level === "number" && storedPet.level >= 1) {
    pet = storedPet;
    foodStock = storedFood || { meat:100, fruit:100, leaf:100 };
  } else {
    // Data kosong atau rusak ‚Üí buat baru
    console.warn("‚ö†Ô∏è Data pet tidak valid atau kosong. Membuat default baru.");
    pet = {
      level: 1,
      exp: 0,
      stage: "egg",
      hunger: 30,
      coins: 0,
      stats: { att: 10, def: 10, spd: 10, acc: 10, crit: 10 },
      statPoints: 0,
      name: "Petku",
      owner: "Guest"
    };
    foodStock = { meat: 100, fruit: 100, leaf: 100 };
    localStorage.setItem("petData", JSON.stringify(pet));
    localStorage.setItem("foodStock", JSON.stringify(foodStock));
  }

} catch (e) {
  console.error("‚ùå Gagal memuat data pet:", e);
  // fallback ke default
  pet = {
    level: 1,
    exp: 0,
    stage: "egg",
    hunger: 30,
    coins: 0,
    stats: { att: 10, def: 10, spd: 10, acc: 10, crit: 10 },
    statPoints: 0,
    name: "Petku",
    owner: "Guest"
  };
  foodStock = { meat: 100, fruit: 100, leaf: 100 };
  localStorage.setItem("petData", JSON.stringify(pet));
  localStorage.setItem("foodStock", JSON.stringify(foodStock));
}

// üö´ Jangan updateUI() di sini dulu!
// Tunggu sampai Firebase selesai load login state di onAuthStateChanged.

  

// ‚úÖ Menentukan apakah pet bisa berevolusi
function canEvolve(pet) {
  const nextStages = {
    egg:    { level: 10, next: "chick" },
    chick:  { level: 20, next: "rooster" },
    rooster:{ level: 30, next: "phoenix" },
    phoenix:{ level: 40, next: null } // üö´ mentok di sini
  };

  const rule = nextStages[pet.stage];
  if (!rule) return false;            // jika stage tidak dikenali
  if (!rule.next) return false;       // jika sudah mentok (phoenix)
  return pet.exp >= 100 && pet.level >= rule.level;
}

  
// === Bubble Kumpulan ===
// === Mini-bubble untuk coin / stat (aman & clamp posisi layar) ===
function createMiniBubble(text, x, y, duration = 2000) {
  const b = document.createElement("div");
  b.className = "mini-bubble";
  b.textContent = text;
  // Posisi sementara: fixed (relatif viewport)
  // x,y dalam pixel (biasanya dari getBoundingClientRect)
  // Clamp agar tidak keluar layar
  const pad = 8;
  const left = Math.max(pad, Math.min(window.innerWidth - pad - 120, x)); // 120 ~ approx bubble width
  const top  = Math.max(pad, Math.min(window.innerHeight - pad - 40, y));
  b.style.left = left + "px";
  b.style.top  = top + "px";
  document.body.appendChild(b);
  setTimeout(() => b.remove(), duration);
  return b;
}

function showCoinBubble(text) {
  const icon = document.getElementById("coinDisplay");
  if (!icon) {
    // fallback: buat mini di pojok atas kiri
    createMiniBubble(text, 20, 20);
    return;
  }
  const rect = icon.getBoundingClientRect();
  // tempatkan sedikit di atas ikon
  const x = rect.left + rect.width / 2 - 30; // shift supaya bubble center-ish
  const y = rect.top - 28;
  createMiniBubble(text, x, y);
}

function showStatBubble(text) {
  const icon = document.getElementById("statsIcon");
  if (!icon) {
    createMiniBubble(text, window.innerWidth - 140, 20);
    return;
  }
  const rect = icon.getBoundingClientRect();
  const x = rect.left + rect.width / 2 - 30;
  const y = rect.top - 28;
  createMiniBubble(text, x, y);
}

let inBattle = false;

function showBubble(text) {
  if (inBattle) return;

  // Hapus mini bubble jika ada
  document.querySelectorAll(".mini-bubble").forEach(el => el.remove());

  const bubble = document.getElementById("bubble");
  const pet = document.getElementById("pet");
  if (!bubble || !pet) return;

  // Tampilkan bubble untuk hitung posisi
  bubble.textContent = text;
  bubble.style.display = "block";
  bubble.style.opacity = 1;

  // Hitung posisi di sisi kanan pet
  const petRect = pet.getBoundingClientRect();
  const bubbleRect = bubble.getBoundingClientRect();
  let left = petRect.right + 10;
  let top = petRect.top + petRect.height / 2 - bubbleRect.height / 2;

  // Cegah keluar layar
  const maxRight = window.innerWidth - 10;
  const bubbleRight = left + bubbleRect.width;
  if (bubbleRight > maxRight) left = maxRight - bubbleRect.width - 10;

  const maxTop = window.innerHeight - bubbleRect.height - 10;
  if (top > maxTop) top = maxTop;
  if (top < 10) top = 10;

  bubble.style.left = `${left}px`;
  bubble.style.top = `${top}px`;

  // Jalankan animasi aktif (sinkron dengan petJump)
  bubble.classList.add("active");

  // Hilangkan perlahan setelah animasi selesai
  setTimeout(() => {
    bubble.classList.remove("active");
    bubble.style.opacity = 0;
    setTimeout(() => (bubble.style.display = "none"), 2000);
  }, 2000);
}



// ================== Fungsi helper ==================
function setPetAnimation(state) {
  const pet = document.getElementById("pet");
  // Jika sedang mode Play, abaikan perubahan apapun
  if (pet.dataset.state === "playing") return;

  pet.classList.remove("idle", "hungry", "pet-fly", "pet-play-spin");
  pet.style.animation = "";
  if (state === "idle") pet.classList.add("idle");
  if (state === "hungry") pet.classList.add("hungry");
}



// ================== Tombol Play ==================
function playWithPet() {
  const btn = document.getElementById("playBtn");
  if (btn.disabled) return; // cooldown

  const petImg = document.getElementById("pet");
  if (!petImg) return;

  // Kurangi hunger
  pet.hunger = Math.max(0, pet.hunger - 10);
  updateUI();

  // Stop semua animasi lama dulu
  petImg.classList.remove("idle", "hungry", "pet-fly");

  // Trigger ulang animasi jump
  void petImg.offsetWidth; // üîß trik reflow agar animasi restart
  petImg.classList.add("pet-fly");

  // Bubble text
  showBubble("üéÆ Bermain seru! Hunger -10%");

  // Setelah loncat selesai (3s), kembali idle/hungry
  setTimeout(() => {
    petImg.classList.remove("pet-fly");
    if (pet.hunger <= 0) petImg.classList.add("hungry");
    else petImg.classList.add("idle");
  }, 3000);

  // Cooldown tombol
  btn.disabled = true;
  btn.textContent = "‚è≥ Tunggu...";
  setTimeout(() => {
    btn.disabled = false;
    btn.textContent = "üéÆ Play";
  }, 5000);
}









// ================== (Opsional) touch pet disabled ==================
// Jika sebelumnya ada event sentuh pet untuk terbang kecil,
// hapus atau comment supaya tidak bentrok dengan playWithPet



function toggleLogin(){
  const p=document.getElementById("loginBox");
  p.style.display = (p.style.display==="block" ? "none" : "block");
}

function getTotalPower(){
  let s = pet.stats;
  // total power = jumlah semua stats
  return s.att + s.def + s.spd + s.acc + s.crit;
}

// === DEFAULT ENEMY DATA (Dummy, mengikuti level player) ===
let enemyData = {
  uid: "dummy001",
  name: "Dummy",
  stats: {},
  isDummy: true,
};

// === PERBARUI STATS DUMMY SESUAI LEVEL PLAYER ===
function updateDummyEnemy() {
  const lvl = pet.level || 1;

  // Rumus sederhana agar seimbang tapi tetap menantang
  const baseAtk = 5 + lvl * 2;      // serangan meningkat tiap level
  const baseDef = 4 + lvl * 1.5;
  const baseCrit = 1 + Math.floor(lvl / 5);
  const baseAcc  = 1 + Math.floor(lvl / 4);
  const baseSpd  = 2 + Math.floor(lvl / 3);

  enemyData.stats = {
    attack: baseAtk,
    defense: baseDef,
    crit: baseCrit,
    acc: baseAcc,
    spd: baseSpd
  };

  // Hitung total power sesuai rumus battle
  const calc = calculateBattlePower(enemyData);
  enemyData.totalAtk = calc.totalAtk;
  enemyData.totalDef = calc.totalDef;
  enemyData.totalPower = calc.totalPower;
}


// === Ganti lawan (dummy ‚Üí online)
function setEnemyData(data) {
  if (!data) return;
  enemyData = {
    uid: data.uid || "unknown",
    name: data.name || "Lawan",
    stats: data.stats || { attack: 10, defense: 10, crit: 5, acc: 5, spd: 5 },
    isDummy: !!data.isDummy,
  };
  const calc = calculateBattlePower(enemyData);
  enemyData.totalAtk = calc.totalAtk;
  enemyData.totalDef = calc.totalDef;
  enemyData.totalPower = calc.totalPower;
  console.log("‚öîÔ∏è Enemy data set:", enemyData);
}

function toggleBattle() {
  const popup = document.getElementById("battlePopup");

  if (popup.style.display === "block") {
    // üîª Tutup popup dengan efek fade-out
    popup.style.opacity = "0";
    popup.style.transform = "translateY(-10px)";
    setTimeout(() => (popup.style.display = "none"), 300);
  } else {
    // üîπ Siapkan data battle terbaru
    updateDummyEnemy();
    updateUI();
    updateBattlePopup();

    // üîπ Tampilkan popup dengan efek fade-in
    popup.style.display = "block";
    setTimeout(() => {
      popup.style.opacity = "1";
      popup.style.transform = "translateY(0)";
    }, 10);
  }
}


// === Efek fly text untuk hasil Battle ===
function showBattleFlyText(text, color = "#ffeb3b") {
  const fly = document.createElement("div");
  fly.className = "flytext-battle";
  fly.textContent = text;
  fly.style.color = color;

  // gaya dasar
  fly.style.position = "fixed";
  fly.style.left = "50%";
  fly.style.top = "50%"; // tengah layar vertikal
  fly.style.transform = "translate(-50%, -50%)";
  fly.style.fontSize = "6vw";
  fly.style.fontWeight = "bold";
  fly.style.textShadow = "2px 2px 6px rgba(0,0,0,0.6)";
  fly.style.zIndex = "9999";
  fly.style.opacity = "1";
  fly.style.transition = "all 1.2s ease-out";

  document.body.appendChild(fly);

  // animasi terbang ke atas + hilang
  setTimeout(() => {
    fly.style.top = "30%"; // dari tengah naik sedikit
    fly.style.opacity = "0";
  }, 100);

  // hapus setelah selesai animasi
  setTimeout(() => fly.remove(), 1200);
}

// === HITUNG HASIL BATTLE BERDASARKAN RUMUS BARU ===
function startBattle() {
  const myPower = pet.totalPower || 0;
  const enemyPower = enemyData.totalPower || 0;

  let resultText = "";
  let flyText = "";
  let flyColor = "#ffeb3b";

  if (myPower > enemyPower) {
    resultText = "üèÜ Kamu menang! +20üí∞";
    flyText = "üèÜ MENANG +20üí∞";
    flyColor = "#00ff00";
    pet.coins += 20;
  } else if (myPower < enemyPower) {
    resultText = "üíÄ Kalah... coba lagi!";
    flyText = "üíÄ KALAH -5üí∞";
    flyColor = "#ff4444";
    pet.coins = Math.max(0, pet.coins - 5);
  } else {
    resultText = "ü§ù Seri! Tidak ada perubahan.";
    flyText = "ü§ù SERI";
    flyColor = "#ffaa00";
  }

  // Tutup popup lebih dulu
  const popup = document.getElementById("battlePopup");
  popup.style.display = "none";

  // üåü Tampilkan bubble teks utama & efek melayang
  showBattleFlyText(flyText, flyColor);

  // Perbarui tampilan setelah animasi selesai
  setTimeout(() => {
    updateUI();
  }, 1600);
}


function calculateAtkPower(pet) {
  const atk = pet.stats?.attack || 0;
  const lvl = pet.level || 1;
  return Math.floor(atk * 8 + lvl * 2); // bisa ubah rumus sesuai keinginan
}

function calculateDefPower(pet) {
  const def = pet.stats?.defense || 0;
  const lvl = pet.level || 1;
  return Math.floor(def * 6 + lvl * 1.5);
}


function updatePetLevel(level) {
  const levelDisplay = document.getElementById("petLevel");
  if (levelDisplay) levelDisplay.textContent = `Level ${level}`;
}


function getPetImage(stage){
  switch(stage){
    case "egg": return "images/egg.png";
    case "chick": return "images/chick.png";
    case "rooster": return "images/rooster.png";
    case "phoenix": return "images/phoenix.png";
  }
}


function playSound(id){
  const s=document.getElementById(id);
  if(s){ try{s.currentTime=0;s.play();} catch(e){} }
}

// === 5. Fungsi utama memberi makan Pet ===

  let feeding = false; // ‚õî mencegah dobel klik feed

function Pet() {
  if (feeding) return; // cegah spam
  feeding = true;

  if (!selectedFood) {
    showBubble("Pilih makanan dulu!");
    feeding = false;
    return;
  }
  if (foodStock[selectedFood] <= 0) {
    showBubble("Stok habis!");
    feeding = false;
    return;
  }

  // === Hitung hasil makan ===
  const hungerGain = 20;
  const expGain =
    selectedFood === "meat" ? 10 :
    selectedFood === "fruit" ? 5 : 2.5;

  // Update data langsung
  pet.hunger = Math.min(100, pet.hunger + hungerGain);
  pet.exp = Math.min(100, pet.exp + expGain);
  pet.coins++;
  foodStock[selectedFood]--;

  // Efek teks pada slot makanan
  const slotDiv = document.querySelector(`.slot[data-food="${selectedFood}"]`);
  if (slotDiv) {
    const fly = document.createElement("div");
    fly.className = "flytext";
    fly.textContent = `+${expGain}% EXP`;
    slotDiv.appendChild(fly);
    setTimeout(() => fly.remove(), 1000);
  }

  // Efek suara dan bubble
  playSound("sound");
  showBubble(`Nyam nyam üçñ +${expGain}% EXP, +1 koin!`);
  showCoinBubble("+1 üí∞");
// === Bubble tengah layar di atas piring ===
const plate = document.getElementById("plateWrapper");
const rect = plate.getBoundingClientRect();
createMiniBubble(`+${expGain}% EXP, +1 üí∞`, rect.left + rect.width/2, rect.top - 30);

  updateUI(); // update stok dan exp bar seketika

  // Animasi makan (1 detik)
  const petImg = document.getElementById("pet");
  petImg.classList.add("pet-fly");

  // === Cek kondisi evolusi / level up ===
  // === Cek kondisi evolusi / level up ===
const evoBtn = document.getElementById("evoBtn");
const feedBtn = document.getElementById("feedBtn");
const playBtn = document.getElementById("playBtn");
const glow = document.getElementById("evoGlow");

if (canEvolve(pet)) {
  evoBtn.style.display = "inline-block";
  evoBtn.disabled = false;
  feedBtn.disabled = true;
  playBtn.disabled = true;
  glow.style.display = "block";
  startSparkle();
  showBubble("‚ú® Saatnya evolusi! Tekan tombol Evo Sekarang!");
} 
else if (pet.exp >= 100 && pet.level < 40) {
  // Level up normal (belum mencapai batas)
  setTimeout(() => {
    playSound("soundLevel");
    pet.level++;
    pet.exp = 0;
    pet.coins += 5;
    pet.statPoints += 10;
    showBubble("Level naik! Sekarang level " + pet.level);
    updatePetLevel(pet.level);
    showCoinBubble("+5 üí∞");
    showStatBubble("+10 üìä Stats");
    updateUI();
  }, 500);
} 
else if (pet.level >= 40) {
  // üîí Level maksimum
  pet.exp = 100;
  showBubble("üåü Level maksimum tercapai!");
}


  // Lepas animasi & izinkan klik lagi setelah 1 detik
  setTimeout(() => {
    petImg.classList.remove("pet-fly");
    feeding = false; // baru boleh klik lagi
  }, 1000);
}



// === Fungsi evolusi Pet ===

function evolvePet() {
  if (evoAnimating) return;
  evoAnimating = true;

  const evoBtn = document.getElementById("evoBtn");
  const glow = document.getElementById("evoGlow");
  const petImg = document.getElementById("pet");

  playSound("soundEvo");

  // üîß Pastikan posisi glow tepat di tengah pet
  const petRect = petImg.getBoundingClientRect();
  glow.style.position = "absolute";
  glow.style.left = `${petRect.left + petRect.width / 2}px`;
  glow.style.top = `${petRect.top + petRect.height / 2}px`;
  glow.style.transform = "translate(-50%, -50%)";
  glow.style.width = `${petRect.width * 1.4}px`;
  glow.style.height = `${petRect.height * 1.4}px`;

  glow.style.display = "block";
  glow.classList.add("active"); // gunakan class CSS aktif (bukan .evo-pulse)

  showBubble("üåü Evolusi sedang berlangsung...");

  setTimeout(() => {
if (pet.stage === "egg" && pet.level >= 10) {
      pet.stage = "chick";
      petImg.src = "images/chick.png";
      showBubble("üê£ Menetas jadi Chick!");
    } 
    else if (pet.stage === "chick" && pet.level >= 20) {
      pet.stage = "rooster";
      petImg.src = "images/rooster.png";
      showBubble("üêì Berevolusi jadi Rooster!");
    } 
    else if (pet.stage === "rooster" && pet.level >= 30) {
      pet.stage = "phoenix";
      petImg.src = "images/phoenix.png";
      showBubble("üî• Berevolusi jadi Phoenix!");
    } 
    else {
      showBubble("üö´ Tidak bisa berevolusi lebih lanjut!");
      evoAnimating = false;
      glow.style.display = "none";
      evoBtn.style.display = "none";
      return;
    }

    // === Reset status setelah evolusi ===
    pet.exp = 0;
    pet.level++;             // naik 1 level setelah evolusi
    pet.coins += 10;         // bonus evolusi
    pet.statPoints += 20;    // bonus stat
    updateUI();

    // === UI cleanup ===
    evoBtn.style.display = "none";
    document.getElementById("feedBtn").disabled = false;
    document.getElementById("playBtn").disabled = false;
    glow.style.display = "none";
    glow.classList.remove("evo-pulse");

    showCoinBubble("+10 üí∞");
    showStatBubble("+20 üìä Stats");

    evoAnimating = false;
  }, 2000);
}


/* === PATCH ANIMASI PET 2025-10 === */

/**
 * Ubah animasi pet antara idle / hungry
 * agar tidak bentrok transform dan lebih halus
 */
function updatePetAnimation() {
  const petImg = document.getElementById("pet");
  if (!petImg) return;

  petImg.classList.remove("idle", "hungry");

  if (pet.hunger <= 0) {
    petImg.classList.add("hungry");
  } else {
    petImg.classList.add("idle");
  }
}

// Jalankan setiap kali UI diperbarui
const _oldUpdateUI = updateUI;
updateUI = function() {
  _oldUpdateUI();     // panggil versi lama
  updatePetAnimation(); // perbarui animasi
};

// Jalankan saat pertama kali halaman dimuat
document.addEventListener("DOMContentLoaded", updatePetAnimation);

// === HITUNG TOTAL POWER SESUAI RUMUS BARU ===
// Total Atk = atk + crit + acc
// Total Def = def + spd
// Total Power = totalAtk + totalDef * 0.6
function calculateBattlePower(pet) {
  const atk = pet.stats?.attack || 0;
  const def = pet.stats?.defense || 0;
  const crit = pet.stats?.crit || 0;
  const acc = pet.stats?.acc || 0;
  const spd = pet.stats?.spd || 0;

  const totalAtk = atk + crit + acc;
  const totalDef = def + spd;
  const totalPower = totalAtk + totalDef * 0.6;

  return {
    totalAtk: Math.round(totalAtk),
    totalDef: Math.round(totalDef),
    totalPower: Math.round(totalPower),
  };
}

 // === UPDATE UI ===
function updateUI() {
  if (isNaN(pet.hunger)) pet.hunger = 0;
  if (isNaN(pet.exp)) pet.exp = 0;
  if (isNaN(pet.coins)) pet.coins = 0;

  // === STATUS DASAR PET ===
  document.getElementById("level").textContent = pet.level;
  document.getElementById("coinDisplay").textContent = "üí∞ " + pet.coins;

  // === BAR EXP ===
const expFill = document.getElementById("expFill");
const expText = document.getElementById("expText");

if (expFill) expFill.style.width = `${pet.exp}%`;
if (expText) expText.textContent = `EXP ${pet.exp.toFixed(1)}%`;

  
  // === BAR HUNGER (THERMOMETER) ===
  const thermo = document.getElementById("thermometer");
  if (thermo) {
    const bars = thermo.querySelectorAll(".bar");
    const label = thermo.querySelector(".thermo-label");
    if (isNaN(pet.hunger)) pet.hunger = 0;
    const hungerVal = Math.max(0, Math.min(100, pet.hunger));
    const activeCount = Math.round((hungerVal / 100) * bars.length);
    bars.forEach((bar, i) => {
      if (i < activeCount) bar.classList.add("active");
      else bar.classList.remove("active");
    });
    if (label) label.textContent = Math.floor(hungerVal) + "%";
  }

  // === Gambar Pet ===
  const petImg = document.getElementById("pet");
  petImg.src = getPetImage(pet.stage);

  // === STOK MAKANAN DI SLOT ===
  document.querySelectorAll(".slot[data-food]").forEach(slot => {
    const type = slot.dataset.food;
    const count = foodStock[type] || 0;
    slot.querySelector(".count").textContent = count;
  });

  // === Update stok makanan ===
  for (let food in foodStock) {
    const countEl = document.getElementById(`count-${food}`);
    const slotEl = document.querySelector(`.slot[data-food='${food}']`);
    if (countEl) countEl.textContent = foodStock[food];
    if (!slotEl) continue;
    if (foodStock[food] <= 0) slotEl.classList.add("disabled");
    else slotEl.classList.remove("disabled");
  }
  
  // === PELAT MAKANAN ===
  const plateFood = document.getElementById("plateFood");
  if (selectedFood && foodStock[selectedFood] > 0) {
    plateFood.src = "images/" + selectedFood + ".png";
    plateFood.style.display = "block";
  } else {
    plateFood.style.display = "none";
  }

  // === TOMBOL EVOLUSI ===
  const evoBtn = document.getElementById("evoBtn");
  const evoGlow = document.getElementById("evoGlow");
  if (
    (pet.level === 10 && pet.stage === "egg" && pet.exp >= 100) ||
    (pet.level === 20 && pet.stage === "chick" && pet.exp >= 100) ||
    (pet.level === 30 && pet.stage === "rooster" && pet.exp >= 100)
  ) {
    evoBtn.style.display = "inline-block";
    evoGlow.style.display = "block";
  } else {
    evoBtn.style.display = "none";
    evoGlow.style.display = "none";
  }

  // === INFORMASI IDENTITAS PET ===
const ownerEl = document.getElementById("ownerName");
const petNameEl = document.getElementById("petName");
const powerAtkEl = document.getElementById("petPowerAtk");
const powerDefEl = document.getElementById("petPowerDef");

if (!pet.stats) pet.stats = { attack: 1, defense: 1 };
if (!pet.ownerName) pet.ownerName = auth?.currentUser?.email?.split("@")[0] || "Tamu";
if (!pet.name) pet.name = "Bulu";

if (ownerEl) ownerEl.textContent = "üë§ Pemilik: " + pet.ownerName;
if (petNameEl) petNameEl.textContent = "üêæ Nama Pet: " + pet.name;


// === Hitung total power baru ===
if (!pet.stats) pet.stats = { attack: 1, defense: 1, crit: 0, acc: 0, spd: 0 };
const battle = calculateBattlePower(pet);
pet.totalAtk = battle.totalAtk;
pet.totalDef = battle.totalDef;
pet.totalPower = battle.totalPower;

// === Tampilkan hasil ke layar ===
const atkEl = document.getElementById("petPowerAtk");
const defEl = document.getElementById("petPowerDef");
const totalEl = document.getElementById("petPowerTotal");

if (atkEl) atkEl.textContent = "‚öîÔ∏è Power Atk: " + pet.totalAtk;
if (defEl) defEl.textContent = "üõ°Ô∏è Power Def: " + pet.totalDef;
if (totalEl) totalEl.textContent = "üî• Total Power: " + pet.totalPower;


  // === SIMPAN KE LOCAL STORAGE ===
  localStorage.setItem("petData", JSON.stringify(pet));
  localStorage.setItem("foodStock", JSON.stringify(foodStock));
  if (typeof auth !== 'undefined' && auth.currentUser) saveUserData(auth.currentUser.uid);

  // === KUNCI TAMBAHAN: Matikan Feed & Play saat Evo aktif ===
  const glow = document.getElementById("evoGlow");
  const feedBtn = document.getElementById("feedBtn");
  const playBtn = document.getElementById("playBtn");

  if (
    evoBtn.style.display === "inline-block" &&
    glow.style.display === "block"
  ) {
    feedBtn.disabled = true;
    playBtn.disabled = true;
  } else if (evoAnimating) {
    feedBtn.disabled = true;
    playBtn.disabled = true;
  } else {
    feedBtn.disabled = false;
    playBtn.disabled = false;
  }
  updateDummyEnemy();
    // Jika Stats popup sedang terbuka, perbarui total power juga
  if (document.getElementById("statsPopup").style.display === "block") {
    const totalPowerEl = document.getElementById("popupTotalPower");
    if (totalPowerEl) totalPowerEl.textContent = pet.totalPower || 0;
  }


}

// === PERBARUI ISI POPUP BATTLE ===
function updateBattlePopup() {
  const playerAtkEl = document.getElementById("playerAtk");
const playerDefEl = document.getElementById("playerDef");
const playerTotalEl = document.getElementById("playerTotal");

  const enemyAtkEl = document.getElementById("enemyAtk");
  const enemyDefEl = document.getElementById("enemyDef");
  const enemyTotalEl = document.getElementById("enemyTotal");
  const enemyInfoEl = document.getElementById("enemyInfo");

if (playerAtkEl) playerAtkEl.textContent = pet.totalAtk || 0;
if (playerDefEl) playerDefEl.textContent = pet.totalDef || 0;
if (playerTotalEl) playerTotalEl.textContent = pet.totalPower || 0;


  if (enemyAtkEl) enemyAtkEl.textContent = enemyData.totalAtk || 0;
  if (enemyDefEl) enemyDefEl.textContent = enemyData.totalDef || 0;
  if (enemyTotalEl) enemyTotalEl.textContent = enemyData.totalPower || 0;

  if (enemyInfoEl)
    enemyInfoEl.firstChild.textContent = `Musuh ${enemyData.name || "???"}`;
}



function startSparkle(){
  const w=document.getElementById("petWrapper");
  for(let i=0;i<15;i++){
    setTimeout(()=>{
      const spark=document.createElement("div");
      spark.className="sparkle";
      spark.style.left=(Math.random()*200)+"px";
      spark.style.top=(Math.random()*200)+"px";
      w.appendChild(spark);
      setTimeout(()=>spark.remove(),1500);
    },i*180);
  }
}

function setupDrag(){
  document.querySelectorAll('.slot[data-food]').forEach(item=>{
    const foodType=item.dataset.food;
    const handler=(ev)=>{ ev.preventDefault(); startDrag(ev,foodType); };
    item.addEventListener('touchstart',handler);
    item.addEventListener('mousedown',handler);
  });
}
  
function resizeGame() {
  // Ukuran dasar disesuaikan ke rasio tinggi HP (portrait)
  const baseWidth = 540;   // ukuran lebar dasar game
  const baseHeight = 960;  // ukuran tinggi dasar game

  const scaleX = window.innerWidth / baseWidth;
  const scaleY = window.innerHeight / baseHeight;
  const scale = Math.min(scaleX, scaleY);

  // Terapkan skala ke CSS
  document.documentElement.style.setProperty('--scale', scale);
}


// === LOGOUT SYSTEM ===
document.getElementById("logoutBtn").onclick = function() {
  document.getElementById("logoutPopup").style.display = "block";
};

function confirmLogout() {
  auth.signOut()
    .then(() => {
      console.log("‚úÖ User berhasil logout dari Firebase.");

      // Bersihkan data lokal
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("emailForSignIn");
      
      // Reset data game ke mode guest
      pet.owner = "Guest";
      updateUI();

      // Sembunyikan popup dan tombol logout
      document.getElementById("logoutPopup").style.display = "none";
      document.getElementById("logoutBtn").style.display = "none";

      alert("Anda telah logout.");
      showBubble("Anda keluar dari akun.");
    })
    .catch((error) => {
      alert("‚ùå Gagal logout: " + error.message);
      console.error(error);
    });
}


function cancelLogout() {
  document.getElementById("logoutPopup").style.display = "none";
}

function startDrag(ev, foodType) {
  ev.preventDefault();

  // Buat gambar kloning untuk efek seret
  const clone = document.createElement('img');
  clone.src = 'images/' + foodType + '.png';
  clone.style.position = 'fixed';
  clone.style.width = '60px';
  clone.style.opacity = 0.8;
  clone.style.zIndex = 1000;
  document.body.appendChild(clone);

  function moveHandler(e) {
    const t = e.touches ? e.touches[0] : e;
    clone.style.left = t.clientX - 30 + 'px';
    clone.style.top = t.clientY - 30 + 'px';
  }

  function endHandler(e) {
    const t = e.changedTouches ? e.changedTouches[0] : e;
    const plate = document.getElementById('plateWrapper').getBoundingClientRect();
    const dx = t.clientX - (plate.left + plate.width / 2);
    const dy = t.clientY - (plate.top + plate.height / 2 - 15);
    const distance = Math.sqrt(dx * dx + dy * dy);

    // Jika dilepas di area piring dan stok makanan masih ada
    if (distance <= plate.width * 0.4 && foodStock[foodType] > 0) {
      selectedFood = foodType; // simpan jenis makanan yang disiapkan
      const pf = document.getElementById("plateFood");
      pf.src = "images/" + foodType + ".png";
      pf.style.display = "block";
      showBubble("üçΩÔ∏è " + foodType + " siap di piring!");
    }

    clone.remove();
    document.removeEventListener('mousemove', moveHandler);
    document.removeEventListener('mouseup', endHandler);
    document.removeEventListener('touchmove', moveHandler);
    document.removeEventListener('touchend', endHandler);
  }

  document.addEventListener('mousemove', moveHandler);
  document.addEventListener('mouseup', endHandler);
  document.addEventListener('touchmove', moveHandler);
  document.addEventListener('touchend', endHandler);
}

function setupButtons() {
  const feedBtn = document.getElementById("feedBtn");
  const playBtn = document.getElementById("playBtn");

  if (feedBtn && !feedBtn.dataset.bound) {
    feedBtn.addEventListener("click", Pet);
    feedBtn.dataset.bound = "true";
  }

  if (playBtn && !playBtn.dataset.bound) {
    playBtn.addEventListener("click", playWithPet);
    playBtn.dataset.bound = "true";
  }
}

function resetGame(){
  // Konfirmasi user
  if (!confirm("Yakin ingin reset game? Semua progress akan hilang.")) return;

  // Hapus semua data lama di localStorage
  localStorage.removeItem("petData");
  localStorage.removeItem("foodStock");

  // Buat ulang pet dengan nilai awal
  pet = {
    level: 1,
    exp: 0,
    hunger: 50,
    stage: "egg",
    coins: 0,
    stats: { att: 10, def: 10, spd: 10, acc: 10, crit: 10 },
    statPoints: 0,
    name: "Petku",
    owner: "Player1"
  };

  // Buat ulang stok makanan
  foodStock = { meat: 100, fruit: 100, leaf: 100 };

  // Simpan data baru ke localStorage
  localStorage.setItem("petData", JSON.stringify(pet));
  localStorage.setItem("foodStock", JSON.stringify(foodStock));

  // Perbarui tampilan
  updateUI();

  // Sinkronkan level di info panel dan exp bar
  const petLevelEl = document.getElementById("petLevel");
  if (petLevelEl) petLevelEl.textContent = "Level 1";

  const panelLevelEl = document.getElementById("level");
  if (panelLevelEl) panelLevelEl.textContent = "1";

  // Bubble notifikasi opsional
  try { showBubble("‚úÖ Game berhasil di-reset!"); } catch (e) {}
}

  
function toggleShop() {
  const s = document.getElementById("shopPopup");

  if (s.style.display === "block") {
    s.style.opacity = "0";
    s.style.transform = "translateY(-10px)";
    setTimeout(() => (s.style.display = "none"), 300);
  } else {
    s.style.display = "block";
    setTimeout(() => {
      s.style.opacity = "1";
      s.style.transform = "translateY(0)";
    }, 10);
  }
}


function buyItem(type,price){
  if(pet.coins < price){
    showBubble("Koin tidak cukup!");
    return;
  }
  pet.coins -= price;
  foodStock[type]++;

  // üîä Mainkan suara beli

  playSound("soundBuy");
  showBubble("Beli "+type+" berhasil! -"+price+" koin");
  updateUI();

  const coinDisplay=document.getElementById("coinDisplay");
  coinDisplay.style.transform="scale(1.2)";
  coinDisplay.style.opacity="0.5";
  setTimeout(()=>{
    coinDisplay.style.transform="scale(1)";
    coinDisplay.style.opacity="1";
  },300);
}

function toggleInfo() {
  const panel = document.getElementById("petInfoPanel");
  if (!panel) return;
  if (panel.style.display === "none" || panel.style.display === "") {
    panel.style.display = "block";
  } else {
    panel.style.display = "none";
  }
}

/* === FUNGSI SINKRONISASI INFO PANEL & LEVEL BAR === */
function syncPetInfoUI() {
  try {
    // Simpan ke localStorage
    localStorage.setItem("petData", JSON.stringify(pet));

    // Level atas exp bar
    const petLevelEl = document.getElementById("petLevel");
    if (petLevelEl) petLevelEl.textContent = `Level ${pet.level || 1}`;

    // Level di info panel
    const infoLevelEl = document.getElementById("level");
    if (infoLevelEl) infoLevelEl.textContent = pet.level || 1;

    // Nama dan pemilik
    const petNameEl = document.getElementById("petName");
    if (petNameEl) petNameEl.textContent = `üêæ Nama Pet: ${pet.name || "-"}`;

    const ownerEl = document.getElementById("ownerName");
    if (ownerEl) ownerEl.textContent = `üë§ Pemilik: ${pet.owner || "-"}`;

    // Power
    const atk = pet.stats?.attack ?? pet.stats?.att ?? "-";
    const def = pet.stats?.defense ?? pet.stats?.def ?? "-";
    const total = pet.totalPower ?? (typeof getTotalPower === "function" ? getTotalPower() : "-");

    const atkEl = document.getElementById("petPowerAtk");
    if (atkEl) atkEl.textContent = `‚öîÔ∏è Power Atk: ${atk}`;
    const defEl = document.getElementById("petPowerDef");
    if (defEl) defEl.textContent = `üõ°Ô∏è Power Def: ${def}`;
    const totalEl = document.getElementById("petPowerTotal");
    if (totalEl) totalEl.textContent = `üî• Total Power: ${total}`;
  } catch (e) {
    console.warn("‚ö†Ô∏è syncPetInfoUI error:", e);
  }
}


  
// ===================== STATS =====================
function toggleStats() {
  const p = document.getElementById("statsPopup");
  const isActive = p.classList.contains("active");

  if (isActive) {
    // Tutup popup dengan animasi
    p.classList.remove("active");
    setTimeout(() => (p.style.display = "none"), 300);
  } else {
    // Tampilkan popup dengan animasi
    p.style.display = "block";
    setTimeout(() => p.classList.add("active"), 10);

    drawStatsChart();
    updateStatUI();
  }
}


function updateStatUI(){
  document.getElementById("statPoints").textContent = pet.statPoints;
  const btns = document.getElementById("statButtons");
  btns.innerHTML = "";

  Object.keys(pet.stats).forEach(key=>{
    const row = document.createElement("div");
    row.style.margin = "5px 0";

    // label jumlah stat
    const label = document.createElement("span");
    label.textContent = key.toUpperCase() + ": " + pet.stats[key] + " ";

    // tombol tambah
    const b = document.createElement("button");
    b.textContent = "+";
    b.disabled = pet.statPoints <= 0;
    b.onclick = ()=>{
  pet.stats[key]++;
  pet.statPoints--;
 updateStatUI();
  drawStatsChart();
  updateUI();
  showStatBubble("+"+key.toUpperCase());


};

    row.appendChild(label);
    row.appendChild(b);
    btns.appendChild(row);
  });
    // ‚ö° Tambahkan update Total Power
  const totalPowerEl = document.getElementById("popupTotalPower");
  if (totalPowerEl) {
    const battle = calculateBattlePower(pet);
    totalPowerEl.textContent = battle.totalPower;
  }

}


function drawStatsChart(){
  const c=document.getElementById("statsChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const keys=Object.keys(pet.stats);
  const maxVal=50; // skala maksimum
  const cx=c.width/2, cy=c.height/2, r=80;
  // draw polygon background
  ctx.strokeStyle="gray"; ctx.beginPath();
  keys.forEach((k,i)=>{
    const angle=(Math.PI*2/keys.length)*i - Math.PI/2;
    const x=cx+Math.cos(angle)*r;
    const y=cy+Math.sin(angle)*r;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });

  ctx.closePath(); ctx.stroke();

  // draw stat area
  ctx.fillStyle="rgba(0,150,255,0.5)"; ctx.beginPath();
  keys.forEach((k,i)=>{
    const val=pet.stats[k];
    const ratio=Math.min(1,val/maxVal);
    const angle=(Math.PI*2/keys.length)*i - Math.PI/2;
    const x=cx+Math.cos(angle)*r*ratio;
    const y=cy+Math.sin(angle)*r*ratio;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.closePath(); ctx.fill();
}

// =================================================
setInterval(()=>{ pet.hunger=Math.max(0,pet.hunger-5); if(pet.hunger<50&&Math.random()<0.3){showBubble("Aku lapar ü•∫");} updateUI(); },5000);
const petImg = document.getElementById("pet");

function tapEffect(){
  petImg.style.transition = "transform 0.4s ease, filter 0.4s ease";
  petImg.style.transform = "rotateY(15deg) rotateX(6deg) skewX(3deg) scale(1.05)";
  petImg.style.filter = "drop-shadow(15px 20px 12px rgba(0,0,0,0.6))";
  setTimeout(()=>{
    petImg.style.transform = "";
    petImg.style.filter = "";
  }, 500);
}
document.addEventListener("DOMContentLoaded", () => {
  const evoBtn = document.getElementById("evoBtn");
  evoBtn.addEventListener("click", evolvePet);
});

petImg.addEventListener("click", tapEffect);
petImg.addEventListener("touchstart", tapEffect);
  
</script>

<!-- ==================== END: MAIN GAME LOGIC ==================== -->

<!-- ==================== FIREBASE SDK (keharusan diletakkan AFTER game logic definitions) ==================== -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- ==================== FIREBASE LOGIC / AUTH OBSERVER ==================== -->
<script>
// === KONFIGURASI FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyATd8wK3YMH9zQd-7HN9KT5cHnGgdPdKgU",
  authDomain: "game-pet-57451.firebaseapp.com",
  projectId: "game-pet-57451",
  storageBucket: "game-pet-57451.firebasestorage.app",
  messagingSenderId: "191423922230",
  appId: "1:191423922230:web:63ec169db83005cad05897"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("‚úÖ Firebase persistence: LOCAL (login bertahan setelah reload)");
  })
  .catch((error) => {
    console.error("‚ùå Gagal set persistence:", error);
  });


// === LOGIN EMAIL OTP ===
function sendLoginLink() {
  const email = document.getElementById("emailInput").value.trim();
  if (!email) {
    alert("Masukkan email terlebih dahulu!");
    return;
  }

  const actionCodeSettings = {
    url: "https://nebulon22.github.io/Pet-Evolution/index.html",
    handleCodeInApp: true
  };

  auth.sendSignInLinkToEmail(email, actionCodeSettings)
    .then(() => {
      alert("‚úÖ Link OTP sudah dikirim ke " + email + "\nCek inbox atau folder spam.");
      localStorage.setItem("emailForSignIn", email);
    })
    .catch((error) => {
      alert("‚ùå Gagal kirim OTP: " + error.message);
    });
}


// === CEK LINK LOGIN (saat user klik dari email) ===
if (auth.isSignInWithEmailLink(window.location.href)) {
  let email = localStorage.getItem("emailForSignIn");
  if (!email) email = prompt("Masukkan email Anda untuk verifikasi:");

  auth.signInWithEmailLink(email, window.location.href)
    .then((result) => {
      alert("‚úÖ Login berhasil sebagai: " + result.user.email);
      localStorage.removeItem("emailForSignIn");
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("logoutBtn").style.display = "block";
      loadUserData(result.user.uid);
    })
    .catch((error) => {
      alert("‚ùå Login gagal: " + error.message);
    });
}


// === LOGOUT FINAL HYBRID MODE ===
function logout() {
  if (!confirm("Apakah yakin ingin logout?")) return;

  auth.signOut()
    .then(() => {
      console.log("‚úÖ Firebase: user berhasil logout.");

      // === Reset data game ke kondisi default ===
      pet = {
        level: 1,
        exp: 0,
        stage: "egg",
        hunger: 30,
        coins: 0,
        stats: { att: 10, def: 10, spd: 10, acc: 10, crit: 10 },
        statPoints: 0,
        name: "Petku",
        owner: "Guest"
      };

      foodStock = { meat: 100, fruit: 100, leaf: 100 };
      selectedFood = null;
      evoAnimating = false;

      // === Simpan ulang data default ke localStorage ===
      localStorage.setItem("petData", JSON.stringify(pet));
      localStorage.setItem("foodStock", JSON.stringify(foodStock));

      // === Hapus cache login Firebase (AMAN untuk Chrome & lainnya) ===
      try {
        const key = "firebase:authUser:" + auth.name + ":" + auth.app.options.apiKey;
        localStorage.removeItem(key);             // cache Firebase
        localStorage.removeItem("isLoggedIn");    // flag hybrid
        localStorage.removeItem("emailForSignIn");// email OTP login
      } catch (e) {
        console.warn("‚ö†Ô∏è Tidak bisa hapus cache Firebase:", e);
      }

      // === Perbarui tampilan UI sepenuhnya ===
      const logoutBtn = document.getElementById("logoutBtn");
      const loginBox = document.getElementById("loginBox");
      if (logoutBtn) logoutBtn.style.display = "none";
      if (loginBox) loginBox.style.display = "block";

      updateUI();
      if (typeof syncPetInfoUI === "function") syncPetInfoUI();

      // === Beri notifikasi visual ===
      showBubble("üëã Anda telah logout ‚Äî game di-reset ke mode Guest.");
      alert("Logout berhasil. Data game direset ke awal.");

      console.log("üéØ Logout selesai ‚Äî mode guest aktif & pet direset.");
    })
    .catch((error) => {
      alert("‚ùå Gagal logout: " + error.message);
      console.error("Logout error:", error);
    });
}

      

// === SIMPAN DATA USER KE FIRESTORE (versi aman & alami) ===
function saveUserData(uid) {
  if (!uid || !pet) return;
  try {
    pet.updatedAt = Date.now();
    db.collection("users").doc(uid).set({
      pet: pet,
      foodStock: foodStock,
      coins: pet.coins,
      lastLevel: pet.level,
      updatedAt: Date.now()
    }, { merge: true })
    .then(() => console.log("‚òÅÔ∏è Data tersimpan ke cloud (lvl " + pet.level + ")"))
    .catch((err) => console.error("Gagal simpan data:", err));
  } catch (e) {
    console.warn("‚ö†Ô∏è saveUserData error:", e);
  }
}


// === MUAT DATA USER DARI FIRESTORE (pilih versi terbaru otomatis) ===
async function loadUserData(uid) {
  if (!uid) return;
  try {
    const doc = await db.collection("users").doc(uid).get();
    const localPet = JSON.parse(localStorage.getItem("petData") || "{}");
    const localLevel = localPet.level || 1;

    if (doc.exists) {
      const data = doc.data();
      const cloudLevel = data.lastLevel || data.pet?.level || 1;
      const localTime = localPet.updatedAt || 0;
      const cloudTime = data.updatedAt || 0;

      // === Perbandingan utama ===
      if (localLevel > cloudLevel || localTime > cloudTime) {
        console.log("üì° Data lokal lebih tinggi ‚Üí kirim ke cloud");
        saveUserData(uid);
        return data; // tetap return supaya tidak undefined
      } 
      else if (cloudLevel > localLevel || cloudTime > localTime) {
        console.log("‚òÅÔ∏è Data cloud lebih tinggi ‚Üí gunakan data cloud (lvl " + cloudLevel + ")");
        if (data.pet) pet = data.pet;
        if (data.foodStock) foodStock = data.foodStock;
        pet.coins = data.coins ?? pet.coins;
        localStorage.setItem("petData", JSON.stringify(pet));
        localStorage.setItem("foodStock", JSON.stringify(foodStock));
        return data;
      } 
      else {
        console.log("ü§ù Data seimbang, tidak perlu sinkronisasi");
        return data;
      }
    } 
    else {
      console.log("üî∞ User baru ‚Äî membuat data default di cloud");
      saveUserData(uid);
      return null;
    }
  } catch (error) {
    console.error("‚ùå Gagal memuat data user:", error);
    return null;
  }
}


// === OBSERVER LOGIN STATE (HYBRID FIXED) ===
auth.onAuthStateChanged(async (user) => {
  const loginBox = document.getElementById("loginBox");
  const logoutBtn = document.getElementById("logoutBtn");
  const emailIcon = document.getElementById("emailIcon");

  if (user) {
    console.log("üîë Login terdeteksi:", user.email);
    try {
      const cloudData = await loadUserData(user.uid);
      const storedPet = JSON.parse(localStorage.getItem("petData") || "{}");

      pet = { ...storedPet, ...(cloudData?.pet || {}) };
      foodStock = { ...(JSON.parse(localStorage.getItem("foodStock") || "{}")), ...(cloudData?.foodStock || {}) };

      pet.owner = user.email || "Player";
      if (!pet.name) pet.name = "Pet Kamu üêæ";
      if (!pet.stats) pet.stats = { att:10, def:10, spd:10, acc:10, crit:10 };
      if (!pet.stage) pet.stage= "egg";

      updateUI();

      if (loginBox) loginBox.style.display = "none";
      if (logoutBtn) logoutBtn.style.display = "inline-flex";
      if (emailIcon) {
        emailIcon.style.opacity = "0.3";
        emailIcon.style.pointerEvents = "none";
      }

      localStorage.setItem("isLoggedIn", "true");
    } catch (err) {
      console.warn("‚ö†Ô∏è loadUserData gagal, fallback ke lokal:", err);
      const storedPet = localStorage.getItem("petData");
      if (storedPet) pet = JSON.parse(storedPet);
      updateUI();
    }
  } else {
    console.log("üö™ Tidak ada user aktif (Guest).");
    const storedPet = localStorage.getItem("petData");
    const storedFood = localStorage.getItem("foodStock");
    if (storedPet) pet = JSON.parse(storedPet);
    if (storedFood) foodStock = JSON.parse(storedFood);

    pet.owner = "Guest";
    evoAnimating = false;
    updateUI();

    if (loginBox) loginBox.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "none";
    if (emailIcon) {
      emailIcon.style.opacity = "1";
      emailIcon.style.pointerEvents = "auto";
    }

    localStorage.removeItem("isLoggedIn");
  }
});

// === AUTO-SAVE SETIAP 30 DETIK ===
setInterval(() => {
  const user = auth.currentUser;
  if (user) saveUserData(user.uid);
}, 30000);
  
// === Sinkron UI setelah halaman selesai load ===
window.addEventListener("load", () => {
  setTimeout(() => {
    updateUI();
    if (typeof syncPetInfoUI === "function") syncPetInfoUI();
  }, 500);
});

  
</script>

<!-- ==================== END: FIREBASE LOGIC ==================== -->

<!-- ==================== INIT / DRAG OBSERVER & HYBRID INIT ==================== -->
<script>
  // Pastikan init berjalan walau DOM sudah ready atau script ditempatkan akhir
  function initGame() {
    console.log("üöÄ initGame()");
    try {
      // updateUI dan setupButtons sudah didefinisikan di main game logic
      updateUI();
      setupButtons();
      activateDragObserver();
      console.log("‚úÖ Game init selesai");
    } catch (err) {
      console.error("‚ùå initGame error:", err);
    }
  }

  // Jika DOM sudah siap, panggil langsung. Jika belum, tunggu DOMContentLoaded
  if (document.readyState === "loading") {
    document.addEventListener('DOMContentLoaded', initGame);
  } else {
    initGame();
  }

  // ActivateDragObserver: memanggil setupDrag() dan memasang MutationObserver pada foodGrid
  function activateDragObserver() {
    try {
      setupDrag();
      const grid = document.getElementById('foodGrid');
      if (!grid) return;
      const observer = new MutationObserver((mutations) => {
        const hasSlotChange = mutations.some(m => m.addedNodes.length || m.removedNodes.length);
        if (hasSlotChange) setupDrag();
      });
      observer.observe(grid, { childList: true, subtree: true });
      console.log('‚úÖ Drag observer aktif');
    } catch (e) {
      console.warn('‚ö†Ô∏è activateDragObserver failed', e);
    }
  }

  // Pastikan #pet menggunakan CSS variable animation (cadangan)
  (function ensurePetAnimVar(){
    const s = document.createElement('style');
    s.textContent = '#pet:not(.pet-fly){ animation: var(--pet-anim, idleMotion 6s ease-in-out infinite, breathing 3s infinite); }';
    document.head.appendChild(s);
  })();


window.onload = function() {
  updateUI();
  initGame();
};


  
</script>

</body>
</html>




































































































































