<!DOCTYPE html>
<html>
<head>

  <title>Game Pet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
  body {
    margin:0; text-align:center; background:#2e7d32; color:white;
    font-family:sans-serif; overflow-x:hidden;
    display:flex; flex-direction:column; align-items:center;
  }

  h2 { margin-top:10px; font-size:6vw; }

 /* CSS (same as before) */
 /* ===== TOP BAR ===== */
#topBar {
  position: fixed;
  top: 5px;
  left: 5px;
  right: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 100;
}

/* Susunan ikon kiri dan kanan */
#leftIcons, #rightIcons {
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

/* Semua ikon utama */
/* ===== Restore Shop look & make other icons match it ===== */

/* Pastikan shop & coin kembali ke gaya semula */
#shopIcon, #coinDisplay {
  font-size: 4.5vw;                 /* ukuran ideal */
  background: rgba(0,0,0,0.3);      /* sama dengan awal */
  padding: 4px 8px;                 /* padding yang pas */
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  min-width: unset;                 /* batalkan min-width yang memaksa */
  min-height: unset;
  box-shadow: none;
  transform: none !important;       /* hapus efek transform bila ada */
}

/* Buat ikon kanan lain persis sama seperti shop (tanpa memaksa ukuran) */
#statsIcon, #emailIcon, #resetBtn, #logoutBtn {
  font-size: 4.5vw;
  background: rgba(0,0,0,0.3);
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  min-width: unset;     /* jangan paksa lebar/tinggi */
  min-height: unset;
  box-shadow: none;
  transform: none;
}

/* Reset aturan global yang mungkin tersisa untuk semua anak */
#leftIcons * , #rightIcons * {
  min-width: unset !important;
  min-height: unset !important;
}

/* Hover/active efek ringan yang aman */
#shopIcon:hover, #statsIcon:hover, #emailIcon:hover, #resetBtn:hover, #logoutBtn:hover {
  background: rgba(255,255,255,0.12);
}
#shopIcon:active, #statsIcon:active, #emailIcon:active, #resetBtn:active, #logoutBtn:active {
  transform: scale(1.06);
}

/* Supaya area klik tetap besar di HP */
#statsIcon, #emailIcon, #resetBtn, #logoutBtn {
  min-width: 10px;
  min-height: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

  #coinDisplay, #shopIcon, #statsIcon, #emailIcon {
    font-size:4.5vw;
    background:rgba(0,0,0,0.3);
    padding:4px 8px;
    border-radius:6px;
    cursor:pointer;
  }

  #resetWrapper {
  margin-left:5px;
  margin-top:30px;   /* ‚úÖ geser agak kebawah */
  }
  #resetBtn {
    font-size:2.5vw;
    padding:4px 6px;
    border-radius:6px;
    opacity:0.6;
  }

  #resetBtn:hover { opacity:1; }


  /* ===== BATTLE ICON ===== */
  #battleIcon {
    position:fixed;
    bottom:10px; right:10px;
    font-size:6vw;
    background:rgba(0,0,0,0.3);
    padding:6px 10px;
    border-radius:8px;
    cursor:pointer;
    z-index:15;
  }
  /* Popup Shop */
  #shopPopup {
    display:none; position:fixed; top:50px; left:10px;
    background:rgba(51,51,51,0.9); padding:15px;
    border-radius:12px; z-index:20;
    text-align:left; width:160px;
  }

  #shopPopup h3 { margin:0 0 10px; font-size:4vw; }
  .shopItem { margin:10px 0; }
  .shopItem button { padding:6px 12px; font-size:3.5vw; }
  /* Popup Stats */
  #statsPopup {
    display:none; position:fixed; top:60px; right:10px;
    background:rgba(51,51,51,0.95); padding:15px;
    border-radius:12px; z-index:30;
    text-align:center; width:220px; font-size: 3.2vw;
  }

  #statsPopup h3 { margin-top:0; font-size:4vw; }
  #statButtons button { margin:3px; font-size:3.2vw; }

  /* üê£ PET IDLE (gerakan lembut tanpa rotate 3D) */
@keyframes idleMotion {
  0%,100% { transform: translateY(0) scale(1); }
  50%     { transform: translateY(-4px) scale(1.03); }
}
#pet {
  animation: idleMotion 4.5s ease-in-out infinite;
  will-change: transform;
}

/* ‚ú® Saat pet lompat bermain */
@keyframes petJump {
  0%   { transform: translateY(0) scale(1); }
  35%  { transform: translateY(-60px) scale(1.05); }
  70%  { transform: translateY(-20px) scale(1.02); }
  100% { transform: translateY(0) scale(1); }
}
.pet-fly { animation: petJump 1s ease-out; will-change: transform; }

/* üåü Bubble utama (ucapan pet, lapar, evolusi) */
#bubble {
  position: absolute;
  left: 50%;
  top: -70px;
  transform: translateX(-50%) scale(0.9);
  background: white;
  color: black;
  padding: 8px 14px;
  border-radius: 12px;
  display: none;
  max-width: 200px;
  text-align: center;
  z-index: 10;
  font-size: 3.6vw;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
  animation: bubblePopFloat 2.3s ease-out forwards;
  will-change: transform, opacity;
}
#bubble::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: -10px;
  transform: translateX(-50%);
  border-width: 10px;
  border-style: solid;
  border-color: white transparent transparent transparent;
}
@keyframes bubblePopFloat {
  0%   { transform: translateX(-50%) scale(0); opacity: 0; }
  10%  { transform: translateX(-50%) scale(1.05); opacity: 1; }
  70%  { transform: translateX(-50%) translateY(-5px) scale(1); opacity: 1; }
  100% { transform: translateX(-50%) translateY(-10px) scale(0.9); opacity: 0; }
}

/* üí∞üìä Mini bubble (coin/stat gain) */
.mini-bubble {
  position: fixed;
  background: rgba(255, 255, 200, 0.95);
  color: #0044cc;
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 3vw;
  opacity: 0;
  z-index: 200;
  pointer-events: none;
  transform: scale(0.8);
  animation: miniPopFloat 2s ease-out forwards;
  will-change: transform, opacity;
}
@keyframes miniPopFloat {
  0%   { transform: scale(0); opacity: 0; }
  15%  { transform: scale(1.05); opacity: 1; }
  80%  { transform: translateY(-18px) scale(1); opacity: 1; }
  100% { transform: translateY(-25px) scale(0.9); opacity: 0; }
}

/* üí´ Sparkle & efek ringan */
.sparkle {
  position: absolute;
  width: 8px; height: 8px;
  background: white;
  border-radius: 50%;
  opacity: 0.8;
  animation: sparkleMove 1.2s forwards;
  pointer-events: none;
  z-index: 2;
  will-change: transform, opacity;
}
@keyframes sparkleMove {
  0%   { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-40px) scale(0.5); opacity: 0; }
}

  .glow {
    position:absolute; width:200px; height:200px;
    background:radial-gradient(circle, rgba(255,255,200,0.8) 0%, transparent 70%);
    animation:glow 2s infinite;
    border-radius:50%; z-index:0; display:none;
  }

  @keyframes glow {
    0%,100%{opacity:0; transform:scale(1);} 
    50%{opacity:0.8; transform:scale(1.2);} 
  }


    .thermometer { display:flex; flex-direction:column-reverse; justify-content:flex-start; width:30px; height:220px; border:2px solid #ccc; border-radius:6px; overflow:hidden; background:#666; position:relative; }
    .bar { flex:1; margin:1px 0; background:#666; }
    .bar.active { opacity:1; }
    .bar:nth-child(2).active{background:#800000;}
    .bar:nth-child(3).active{background:#b22222;}
    .bar:nth-child(4).active{background:#ff4500;}
    .bar:nth-child(5).active{background:#ff8c00;}
    .bar:nth-child(6).active{background:#ffd700;}
    .bar:nth-child(7).active{background:#f0e68c;}
    .bar:nth-child(8).active{background:#adff2f;}
    .bar:nth-child(9).active{background:#7fff00;}
    .bar:nth-child(10).active{background:#32cd32;}
    .bar:nth-child(11).active{background:#00ff00;}
    .thermo-label { position:absolute; left:10%; transform:translateX(-10%); font-size:2vw; color:white;

    text-shadow:1px 1px 2px black;
    white-space: nowrap;
    }


    #labelTop { top:1px; } #labelBottom { bottom:1px; }
    .bar-container { width:80vw; max-width:500px; margin:10px auto; background:#444; border-radius:10px; overflow:hidden; height:24px; }
    #expBar { height:100%; width:0%; text-align:center; color:white; font-size:3.5vw; line-height:24px; background:dodgerblue; transition:width 0.5s ease; }
    button { margin:10px; padding:12px 24px; font-size:4vw; border-radius:10px; }
    button:disabled { opacity:0.5; background:#777 !important; cursor:not-allowed; }
    #resetWrapper { position:fixed; top:5px; right:5px; z-index:10; }
    #resetBtn { font-size:2.5vw; padding:4px 8px; border-radius:6px; opacity:0.6; }
    #resetBtn:hover { opacity:1; }

    
    @keyframes hungry-shake {
  0%   { transform: translate(0, 0) rotate(0deg) scale(1); }
  10%  { transform: translate(-5px, -2px) rotate(-2deg) scale(1.02); }
  20%  { transform: translate(4px, 2px) rotate(2deg) scale(1.02); }
  30%  { transform: translate(-3px, 1px) rotate(-1deg) scale(1.02); }
  40%  { transform: translate(5px, -1px) rotate(2deg) scale(1.02); }
  50%  { transform: translate(-4px, 2px) rotate(-2deg) scale(1.02); }
  60%  { transform: translate(3px, -2px) rotate(1deg) scale(1.02); }
  70%  { transform: translate(-5px, 1px) rotate(-1deg) scale(1.02); }
  80%  { transform: translate(4px, -2px) rotate(2deg) scale(1.02); }
  90%  { transform: translate(-3px, 2px) rotate(-2deg) scale(1.02); }
  100% { transform: translate(0, 0) rotate(0deg) scale(1); }
}

.hungry { }
    @keyframes evoPulse { 0%,100% { transform: scale(1);} 25%{transform:scale(1.3);} 50%{transform:scale(0.7);} 75%{transform:scale(1.4);} }
    @keyframes evoPop { 0%{transform:scale(0);opacity:0;} 80%{transform:scale(1.2);opacity:1;} 100%{transform:scale(1);} }
    .evo-pulse { animation:evoPulse 2s ease-in-out; }
    .evo-pop   { animation:evoPop 0.8s ease-out; }

#plateWrapper { position:relative; margin-top:20px; }
#plate { width:180px; }
#plateFood { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:50%; height:50%; object-fit:contain; display:none; }



    .flytext { position:absolute; left:50%; transform:translateX(-50%) translateY(0); bottom:110%; font-size:12px; color:#fff; text-shadow:1px 1px 2px black; opacity:0; animation:flyUp 1s forwards; pointer-events:none; }
    @keyframes flyUp { 0% { transform:translateX(-50%) translateY(0); opacity:1; } 100% { transform:translateX(-50%) translateY(-30px); opacity:0; } }

  #background {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  overflow: hidden;
  z-index: -10; /* di belakang semua */
}

    /* Langit */
.bg-sky {
  position: absolute;
  width: 100%; height: 100%;
  background: url("images/background.png") no-repeat center bottom;
  background-size: cover;
  z-index: -5;
}

/* Awan */
.cloud {
  position: absolute;
  top: 40px;
  width: 220px;
  animation: moveCloud 60s linear infinite;
  z-index: -4;
}

@keyframes moveCloud {
  from { left: -250px; }
  to   { left: 100%; }
}

/* Pohon goyang */

.tree {
  position: absolute;
  width: 160px;
  transform-origin: bottom center;
  animation: sway 4s ease-in-out infinite alternate;
  z-index: -2;
}

@keyframes sway {
  from { transform: rotate(-2deg); }
  to   { transform: rotate(2deg); }
}

/* Rumput di bawah */
.grass {
  position: absolute;
  bottom: 0;
  width: 120px;
  transform-origin: bottom center;
  animation: sway 3s ease-in-out infinite alternate;
  z-index: -1;
}
    
.bar {
  transition: background 0.3s ease, opacity 0.3s ease;
}
.thermo-label {
  pointer-events: none;
}


#gameContainer {
  position: relative;
  width: 100vw;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

/* === Layout & Spacing Scale Adjustment === */
/* Ruang kosong antar bagian utama */
#gameContent {
  width: 540px;
  height: 960px;
  transform: scale(var(--scale));
  transform-origin: top left;
  position: relative;
  overflow: hidden;
  background: none;
}
  /* Pet wrapper */
  .pet-wrapper {
  display: flex;
  align-items: flex-start;  /* sejajarkan bagian atas */
  justify-content: center;  /* posisikan ke tengah layar */
  gap: 25px;                /* jarak antara thermometer dan pet */
  transform: translateY(40px); /* turunkan sedikit dari atas */
}

#thermometer {
  margin-top: 10px; /* bisa disesuaikan lagi nanti */
}

#pet {
  width: 40vw;
  max-width: 220px;
  height: auto;
  z-index: 1;
  filter: drop-shadow(8px 12px 8px rgba(0,0,0,0.5));
  animation: idleMotion 4.5s ease-in-out infinite;
  will-change: transform;
}

#bubble {
  isolation: isolate; /* pastikan bubble di layer sendiri */
}
#pet, #bubble, .mini-bubble, .flytext {
  will-change: transform, opacity;
}


/* üê£ Pet Area */
#petWrapper {
  margin-top: 100px; /* turunkan sedikit pet dari atas */
}

/* üåü Efek evolusi di tengah pet */
#evoGlow {
  position: absolute;
  top: 15%;
  left: 50%;
  transform: translateX(-50%);
  width: 160px;
  height: 160px;
  z-index: 0;
}

/* ‚ö° EXP Bar */
.bar-container {
  margin: 25px auto 10px auto;
  width: 80%;
  height: 26px;
  border-radius: 12px;
  overflow: hidden;
}

/* üßæ Info text di bawah pet */
#gameContent p {
  margin: 6px 0;
  line-height: 1.4em;
}

/* üéÆ Tombol utama */
#feedBtn, #playBtn, #evoBtn {
  margin: 10px 6px;
  font-size: 3.8vw;
  padding: 8px 16px;
  border-radius: 10px;
  box-shadow: 0 3px 5px rgba(0,0,0,0.3);
}

/* üçΩÔ∏è Piring diatur dengan jarak pas */
#plateWrapper {
  margin-top: 35px;
  margin-bottom: 25px;
  position: relative;
}

/* üçñ Food grid di bawah layar */
#foodGrid {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 1.5vw;                 /* jarak antar kotak relatif layar */
  margin-top: 2vh;
}

/* === Slot kotak makanan === */
.slot {
  width: 12vw;                /* lebar relatif layar */
  aspect-ratio: 1 / 1;        /* tinggi otomatis sama dengan lebar */
  border: 0.3vw solid #999;
  border-radius: 1vw;
  background: rgba(255,255,255,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  transition: transform 0.2s ease;
}

/* Slot aktif & kosong */
.slot.empty {
  background: rgba(255,255,255,0.05);
  border: 0.3vw dashed #666;
}

/* Slot disabled (stok 0) */
.slot.disabled {
  opacity: 0.4;
  filter: grayscale(80%);
  pointer-events: none;
}

/* === Gambar item di dalam slot === */
.slot img {
  width: 80%;
  height: 80%;
  object-fit: contain;
}

/* Jumlah stok */
.slot .count {
  position: absolute;
  bottom: 3px;
  right: 5px;
  color: red;
  font-weight: bold;
  font-size: 3vw;
  text-shadow: 1px 1px 2px black;
}

/* üî• Tambahan: jaga agar semua elemen center */
#gameContent p,
.bar-container,
#plateWrapper,
#foodGrid,
div[style*="text-align:center"] {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}

    
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div id="topBar">
    <div id="leftIcons">
      <div id="coinDisplay">üí∞ 0</div>
      <div id="shopIcon" onclick="toggleShop()">üõí</div>
    </div>
    <div id="rightIcons">
  <div id="statsIcon" onclick="toggleStats()">üìä</div>
  <div id="emailIcon">üìß</div>
  <div id="resetBtn" onclick="resetGame()">üîÑ</div>
  <div id="logoutBtn" style="display:none;">üîì</div>
</div>

  </div>


  <!-- POPUP LOGIN EMAIL -->

  <div id="loginBox" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
    background:rgba(0,0,0,0.85); padding:20px; border-radius:12px; color:white; z-index:100;">
    <h3>üîë Login dengan Email</h3>
    <input id="emailInput" type="email" placeholder="Masukkan email" style="padding:8px; font-size:3.5vw;">
    <button onclick="sendLoginLink()">Kirim Link OTP</button>
    <button onclick="document.getElementById('loginBox').style.display='none'">Tutup</button>
  </div>

<!-- Popup konfirmasi logout -->
<div id="logoutPopup"
  style="display:none; position:fixed; top:40%; left:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.85); padding:20px; border-radius:12px; color:white; z-index:300;">
  <p>Apakah yakin ingin logout?</p>
  <button onclick="confirmLogout()">‚úÖ Ya</button>
  <button onclick="cancelLogout()">‚ùå Batal</button>
</div>

  <!-- BATTLE ICON -->
  <div id="battleIcon" onclick="toggleBattle()">‚öîÔ∏è</div>

  <!-- Popup Shop -->
  <div id="shopPopup">
    <h3>Shop</h3>
    <div class="shopItem"><span>üçñ Daging - 10 koin</span><br><button onclick="buyItem('meat',10)">Beli</button></div>
    <div class="shopItem"><span>üçé Buah - 5 koin</span><br><button onclick="buyItem('fruit',5)">Beli</button></div>
    <div class="shopItem"><span>üåø Daun - 3 koin</span><br><button onclick="buyItem('leaf',3)">Beli</button></div>
    <button onclick="toggleShop()">Tutup</button>
  </div>

  <!-- Popup Stats -->
  <div id="statsPopup">
    <h3>Stats</h3>
    <canvas id="statsChart" width="200" height="200"></canvas>
    <p>Sisa Poin: <span id="statPoints">0</span></p>
    <div id="statButtons"></div>
    <button onclick="toggleStats()">Tutup</button>
  </div>
  <!-- Popup Battle -->
  <div id="battlePopup" style="display:none; position:fixed; top:60px; left:50%; transform:translateX(-50%);
    background:rgba(51,51,51,0.95); padding:15px; border-radius:12px; z-index:40;
    text-align:center; width:240px; font-size:3.2vw;">
    <h3>‚öîÔ∏è Arena Battle</h3>
    <p>Pet: <span id="battlePetName"></span><br>
       Power: <span id="battlePetPower"></span></p>
    <p>Musuh Dummy<br>Power: <span id="enemyPower">100</span></p>
    <button onclick="startBattle()">Mulai</button>
    <button onclick="toggleBattle()">Tutup</button>
  </div>

  
<div id="gameContainer">
  <div id="gameContent">

    <!-- üå§Ô∏è Background Layer -->
    <div id="background">
      <div class="bg-sky"></div>
      <img src="images/cloud.png" class="cloud">
      <img src="images/tree.png" class="tree" style="left:5%; bottom:60px;">
      <img src="images/tree.png" class="tree" style="left:80%; bottom:70px;">
      <img src="images/grass.png" class="grass" style="left:10%;">
      <img src="images/grass.png" class="grass" style="left:40%;">
      <img src="images/grass.png" class="grass" style="left:70%;">
    </div>

    <!-- üê£ Pet Area -->
    <div class="pet-wrapper" id="petWrapper">
      <div class="thermometer" id="thermometer">
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div><div class="bar"></div><div class="bar"></div>
        <div class="bar"></div>
        <span class="thermo-label">0%</span>
        <div id="labelBottom" class="thermo-label" style="bottom:-1.5em;">Lapar</div>
      </div>

      <div class="glow" id="evoGlow"></div>
      <img id="pet" src="images/egg.png">
      <div id="bubble"></div>
    </div>

    <!-- üßæ Info Panel -->
    <p style="font-size:4vw; text-align:center;">Level Pet: <span id="level">1</span></p>
    <p style="font-size:3.8vw; text-align:center;">
      üêæ Nama Pet: <span id="petName"></span><br>
      üë§ Pemilik: <span id="ownerName"></span><br>
      ‚öîÔ∏è Total Power: <span id="totalPower"></span>
    </p>

    <!-- ‚ö° EXP Bar -->
    <div class="bar-container" style="margin:auto; width:80%;">
      <div id="expBar">EXP 0%</div>
    </div>

    <!-- üéÆ Tombol Aksi -->
    <div style="text-align:center; margin-top:10px;">
      <button id="feedBtn">Feed üçñ</button>
      <button id="playBtn">üéÆ Play</button>
      <button id="evoBtn" style="display:none;">‚ú® Evo Sekarang!</button>
    </div>

    <!-- üçΩÔ∏è Piring -->
    <div id="plateWrapper">
      <img id="plate" src="images/plate.png" alt="Piring">
      <img id="plateFood" src="" alt="">
    </div>

    <!-- üçñ Food Grid -->
    <div id="foodGrid">
      <div class="slot" data-food="meat">
        <img src="images/meat.png">
        <div class="count" id="count-meat">100</div>
      </div>
      <div class="slot" data-food="fruit">
        <img src="images/fruit.png">
        <div class="count" id="count-fruit">100</div>
      </div>
      <div class="slot" data-food="leaf">
        <img src="images/leaf.png">
        <div class="count" id="count-leaf">100</div>
      </div>
      <div class="slot empty"></div>
      <div class="slot empty"></div>
    </div>

  </div> <!-- end #gameContent -->
</div> <!-- end #gameContainer -->

  
  <!-- Suara -->
  <audio id="sound" src="sounds/feed.mp3" preload="auto"></audio>
  <audio id="soundLevel" src="sounds/levelup.mp3" preload="auto"></audio>
  <audio id="soundEvo" src="sounds/evo.mp3" preload="auto"></audio>
  <audio id="soundBuy" src="sounds/buy.mp3" preload="auto"></audio>
  
  <script>
    // Klik ikon email untuk buka/tutup popup login
    document.getElementById("emailIcon").onclick = function(){
      const box = document.getElementById("loginBox");
      box.style.display = (box.style.display==="block" ? "none" : "block");
    };
  </script>

  <script>
// === SEMBUNYIKAN LOGOUT SAAT HALAMAN PERTAMA KALI DIMUAT ===
// Tujuannya agar tombol logout tidak muncul duluan sebelum Firebase selesai cek status.
document.addEventListener("DOMContentLoaded", () => {
  const logoutBtn = document.getElementById("logoutBtn");
  if (logoutBtn) logoutBtn.style.display = "none";
});
</script>

<!-- ==================== START: MAIN GAME LOGIC (keharusan diletakkan BEFORE Firebase SDK) ==================== -->
<script>
  // Hapus data lama yang rusak / versi lama
if (!localStorage.getItem("petData") || JSON.parse(localStorage.getItem("petData")).level < 1) {
  localStorage.removeItem("petData");
  localStorage.removeItem("foodStock");
}

let pet = JSON.parse(localStorage.getItem("petData")) || { 
  level:1, exp:0, stage:"egg", hunger:30, coins:0,
  stats:{att:10,def:10,spd:10,acc:10,crit:10},
  statPoints:0,
  name:"Petku",          // üêæ nama pet
  owner:"Player1"        // üë§ pemilik
};

let foodStock = JSON.parse(localStorage.getItem("foodStock")) || {
  meat:100, fruit:100, leaf:100
};

let selectedFood=null;
let evoAnimating=false;

// === Bubble Kumpulan ===
// === Mini-bubble untuk coin / stat (aman & clamp posisi layar) ===
function createMiniBubble(text, x, y, duration = 2000) {
  const b = document.createElement("div");
  b.className = "mini-bubble";
  b.textContent = text;
  // Posisi sementara: fixed (relatif viewport)
  // x,y dalam pixel (biasanya dari getBoundingClientRect)
  // Clamp agar tidak keluar layar
  const pad = 8;
  const left = Math.max(pad, Math.min(window.innerWidth - pad - 120, x)); // 120 ~ approx bubble width
  const top  = Math.max(pad, Math.min(window.innerHeight - pad - 40, y));
  b.style.left = left + "px";
  b.style.top  = top + "px";
  document.body.appendChild(b);
  setTimeout(() => b.remove(), duration);
  return b;
}

function showCoinBubble(text) {
  const icon = document.getElementById("coinDisplay");
  if (!icon) {
    // fallback: buat mini di pojok atas kiri
    createMiniBubble(text, 20, 20);
    return;
  }
  const rect = icon.getBoundingClientRect();
  // tempatkan sedikit di atas ikon
  const x = rect.left + rect.width / 2 - 30; // shift supaya bubble center-ish
  const y = rect.top - 28;
  createMiniBubble(text, x, y);
}

function showStatBubble(text) {
  const icon = document.getElementById("statsIcon");
  if (!icon) {
    createMiniBubble(text, window.innerWidth - 140, 20);
    return;
  }
  const rect = icon.getBoundingClientRect();
  const x = rect.left + rect.width / 2 - 30;
  const y = rect.top - 28;
  createMiniBubble(text, x, y);
}

function showBubble(text){
  const b = document.getElementById("bubble");
  b.textContent = text;
  b.style.display = "block";
  setTimeout(() => b.style.display = "none", 2500);
}



function toggleLogin(){
  const p=document.getElementById("loginBox");
  p.style.display = (p.style.display==="block" ? "none" : "block");
}

function getTotalPower(){
  let s = pet.stats;
  // total power = jumlah semua stats
  return s.att + s.def + s.spd + s.acc + s.crit;
}

function toggleBattle(){
  const p=document.getElementById("battlePopup");
  if(p.style.display==="block"){
    p.style.display="none";
  } else {
    p.style.display="block";
    document.getElementById("battlePetName").textContent = pet.name;
    document.getElementById("battlePetPower").textContent = getTotalPower();
  }
}



function startBattle(){
  let myPower = getTotalPower();
  let enemyPower = 100; // dummy sementara

  if(myPower >= enemyPower){
    showBubble("üèÜ Kamu menang! +20 koin");
    pet.coins += 20;
  } else {
    showBubble("üíÄ Kalah... coba lagi!");
  }
  updateUI();
  toggleBattle();
}


function getPetImage(stage){
  switch(stage){
    case "egg": return "images/egg.png";
    case "chick": return "images/chick.png";
    case "rooster": return "images/rooster.png";
    case "phoenix": return "images/phoenix.png";
  }
}


function playSound(id){
  const s=document.getElementById(id);
  if(s){ try{s.currentTime=0;s.play();} catch(e){} }
}

// ‚úÖ Perbaikan Pet
// === 5. Fungsi utama memberi makan Pet ===
let feeding = false; // ‚õî mencegah dobel klik feed
function Pet() {
  if (feeding) return; // cegah eksekusi ganda
  feeding = true;      // lock sementara

  if (!selectedFood) {
    showBubble("Pilih makanan dulu!");
    feeding = false;
    return;
  }
  if (foodStock[selectedFood] <= 0) {
    showBubble("Stok habis!");
    feeding = false;
    return;
  }

  // === Data dasar ===
  const hungerGain = 20;
  const expGain =
    selectedFood === "meat" ? 10 :
    selectedFood === "fruit" ? 5 : 2.5;

  // === Update hunger & exp ===
  pet.hunger = Math.min(100, pet.hunger + hungerGain);
  foodStock[selectedFood]--; // hanya sekali
  pet.exp = Math.min(100, pet.exp + expGain);
  pet.coins++;

  // === Animasi exp fly ===
  const slotDiv = document.querySelector(`.slot[data-food='${selectedFood}']`);
  const fly = document.createElement("span");
  fly.className = "flytext";
  fly.textContent = `+${expGain}% EXP`;
  slotDiv.appendChild(fly);
  setTimeout(() => fly.remove(), 800);

  playSound("sound");
  showBubble(`Nyam nyam üçñ +${expGain}% EXP, +1 koin!`);

  // === CEK KONDISI EVOLUSI ===
  const evoBtn = document.getElementById("evoBtn");
  const feedBtn = document.getElementById("feedBtn");
  const playBtn = document.getElementById("playBtn");
  const glow = document.getElementById("evoGlow");

  if (
    (pet.level === 10 && pet.stage === "egg" && pet.exp >= 100) ||
    (pet.level === 20 && pet.stage === "chick" && pet.exp >= 100) ||
    (pet.level === 30 && pet.stage === "rooster" && pet.exp >= 100)
  ) {
    evoBtn.style.display = "inline-block";
    evoBtn.disabled = false;              // aktifkan tombol Evo
    glow.style.display = "block";

    feedBtn.disabled = true;              // nonaktifkan tombol lain
    playBtn.disabled = true;

    startSparkle();
    showBubble("‚ú® Saatnya evolusi! Tekan tombol Evo Sekarang!");
  } 
else if (pet.exp >= 100) {
  // === Level up normal (versi sinkron) ===
  playSound("soundLevel");

  // Tunda sedikit supaya EXP bar sempat penuh dulu
  setTimeout(() => {
    pet.level++;
    pet.exp = 0;
    pet.coins += 5;
    pet.statPoints += 10;

    showBubble("Level naik! Sekarang level " + pet.level);
    showCoinBubble("+5 üí∞");
    showStatBubble("+10 üìä Stats");

    // Update UI setelah bubble muncul
    updateUI();
  }
}


// === Fungsi evolusi Pet ===
function evolvePet() {
  if (evoAnimating) return;
  evoAnimating = true;

  const evoBtn = document.getElementById("evoBtn");
  const feedBtn = document.getElementById("feedBtn");
  const playBtn = document.getElementById("playBtn");
  const glow = document.getElementById("evoGlow");
  const petImg = document.getElementById("pet");

  // Nonaktifkan semua tombol selama evolusi
  evoBtn.disabled = true;
  feedBtn.disabled = true;
  playBtn.disabled = true;

  // Tambahkan animasi cahaya
  glow.style.display = "block";
  petImg.classList.add("evo-pulse");
  playSound("soundEvo");

  setTimeout(() => {
    // Ganti stage Pet
    switch (pet.stage) {
      case "egg": pet.stage = "chick"; break;
      case "chick": pet.stage = "rooster"; break;
      case "rooster": pet.stage = "phoenix"; break;
    }

    // Level reset ringan
    pet.exp = 0;
    pet.level++;
    pet.coins += 50;
    pet.statPoints += 20;

    // Update gambar pet
    petImg.src = getPetImage(pet.stage);
    petImg.classList.remove("evo-pulse");
    petImg.classList.add("evo-pop");

    showBubble("üåü Evolusi berhasil! Pet berubah jadi " + pet.stage + "!");
    showCoinBubble("+50 üí∞");
    showStatBubble("+20 üìä");

    // Sembunyikan efek glow
    glow.style.display = "none";
    evoBtn.style.display = "none";

    updateUI();
    localStorage.setItem("petData", JSON.stringify(pet));

    // Lepas semua tombol kembali aktif
    setTimeout(() => {
      evoAnimating = false;
      feedBtn.disabled = false;
      playBtn.disabled = false;
    }, 1200);

  }, 1500);
}


function playWithPet(){
  const btn = document.getElementById("playBtn");
  if(btn.disabled) return; // kalau masih cooldown

  // Kurangi hunger
  pet.hunger = Math.max(0, pet.hunger - 10);
  updateUI();

  // Ambil pet
  const petImg = document.getElementById("pet");
  // Stop animasi idle/hungry, lalu jalankan jump
  petImg.style.animation = "petJump 1s ease-out";
  showBubble("üéÆ Bermain seru! Hunger -10%");
  setTimeout(()=>{
    // kembalikan ke idleMotion atau hungry-shake sesuai kondisi
    if(pet.hunger <= 0){
      petImg.style.animation = "hungry-shake 0.6s infinite";
    } else {
      petImg.style.animation = "idleMotion 6s ease-in-out infinite";
    }
  },1000);

  // Cooldown 5 detik
  btn.disabled = true;
  btn.textContent = "‚è≥ Tunggu...";
  setTimeout(()=>{
    btn.disabled = false;
    btn.textContent = "üéÆ Play";
  },5000);
}

 // === UPDATE UI ===
function updateUI() {
  if (isNaN(pet.hunger)) pet.hunger = 0;
  if (isNaN(pet.exp)) pet.exp = 0;
  if (isNaN(pet.coins)) pet.coins = 0;

  // === STATUS DASAR PET ===
  document.getElementById("level").textContent = pet.level;
  document.getElementById("coinDisplay").textContent = "üí∞ " + pet.coins;

  // === BAR EXP ===
  const expBar = document.getElementById("expBar");
  expBar.style.width = pet.exp + "%";
  expBar.textContent = "EXP " + pet.exp.toFixed(1) + "%";

  // === BAR HUNGER (THERMOMETER) ===
  const thermo = document.getElementById("thermometer");
  if (thermo) {
    const bars = thermo.querySelectorAll(".bar");
    const label = thermo.querySelector(".thermo-label");
    if (isNaN(pet.hunger)) pet.hunger = 0;
    const hungerVal = Math.max(0, Math.min(100, pet.hunger));
    const activeCount = Math.round((hungerVal / 100) * bars.length);
    bars.forEach((bar, i) => {
      if (i < activeCount) bar.classList.add("active");
      else bar.classList.remove("active");
    });
    if (label) label.textContent = Math.floor(hungerVal) + "%";
  }

  // === Gambar Pet ===
  const petImg = document.getElementById("pet");
  petImg.src = getPetImage(pet.stage);

  // === STOK MAKANAN DI SLOT ===
  document.querySelectorAll(".slot[data-food]").forEach(slot => {
    const type = slot.dataset.food;
    const count = foodStock[type] || 0;
    slot.querySelector(".count").textContent = count;
  });
// === Update stok makanan ===
  for (let food in foodStock) {
    const countEl = document.getElementById(`count-${food}`);
    const slotEl = document.querySelector(`.slot[data-food='${food}']`);
    countEl.textContent = foodStock[food];

    if (foodStock[food] <= 0) {
      slotEl.classList.add("disabled");
    } else {
      slotEl.classList.remove("disabled");
    }
  }
  
  // === PELAT MAKANAN ===
  const plateFood = document.getElementById("plateFood");
  if (selectedFood && foodStock[selectedFood] > 0) {
    plateFood.src = "images/" + selectedFood + ".png";
    plateFood.style.display = "block";
  } else {
    plateFood.style.display = "none";
  }

  // === TOMBOL EVOLUSI ===
  const evoBtn = document.getElementById("evoBtn");
  const evoGlow = document.getElementById("evoGlow");
  if (
    (pet.level === 10 && pet.stage === "egg" && pet.exp >= 100) ||
    (pet.level === 20 && pet.stage === "chick" && pet.exp >= 100) ||
    (pet.level === 30 && pet.stage === "rooster" && pet.exp >= 100)
  ) {
    evoBtn.style.display = "inline-block";
    evoGlow.style.display = "block";
  } else {
    evoBtn.style.display = "none";
    evoGlow.style.display = "none";
  }

  // === SIMPAN KE LOCAL STORAGE ===
  localStorage.setItem("petData", JSON.stringify(pet));
  localStorage.setItem("foodStock", JSON.stringify(foodStock));
  if (typeof auth !== 'undefined' && auth.currentUser) saveUserData(auth.currentUser.uid);

  // === KUNCI TAMBAHAN: Matikan Feed & Play saat Evo aktif ===
  const glow = document.getElementById("evoGlow");
  const feedBtn = document.getElementById("feedBtn");
  const playBtn = document.getElementById("playBtn");

  if (
    evoBtn.style.display === "inline-block" &&
    glow.style.display === "block"
  ) {
    feedBtn.disabled = true;
    playBtn.disabled = true;
  } else if (evoAnimating) {
    feedBtn.disabled = true;
    playBtn.disabled = true;
  } else {
    feedBtn.disabled = false;
    playBtn.disabled = false;
  }
}

function startSparkle(){
  const w=document.getElementById("petWrapper");
  for(let i=0;i<15;i++){
    setTimeout(()=>{
      const spark=document.createElement("div");
      spark.className="sparkle";
      spark.style.left=(Math.random()*200)+"px";
      spark.style.top=(Math.random()*200)+"px";
      w.appendChild(spark);
      setTimeout(()=>spark.remove(),1500);
    },i*180);
  }
}

function setupDrag(){
  document.querySelectorAll('.slot[data-food]').forEach(item=>{
    const foodType=item.dataset.food;
    const handler=(ev)=>{ ev.preventDefault(); startDrag(ev,foodType); };
    item.addEventListener('touchstart',handler);
    item.addEventListener('mousedown',handler);
  });
}
  
function resizeGame() {
  // Ukuran dasar disesuaikan ke rasio tinggi HP (portrait)
  const baseWidth = 540;   // ukuran lebar dasar game
  const baseHeight = 960;  // ukuran tinggi dasar game

  const scaleX = window.innerWidth / baseWidth;
  const scaleY = window.innerHeight / baseHeight;
  const scale = Math.min(scaleX, scaleY);

  // Terapkan skala ke CSS
  document.documentElement.style.setProperty('--scale', scale);
}


// === LOGOUT SYSTEM ===
document.getElementById("logoutBtn").onclick = function() {
  document.getElementById("logoutPopup").style.display = "block";
};

function confirmLogout() {
  // Hapus semua data & kembali ke layar awal
 
  document.getElementById("logoutPopup").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";
  alert("Anda telah logout.");
  location.reload(); // atau window.location.href = "index.html";
}

function cancelLogout() {
  document.getElementById("logoutPopup").style.display = "none";
}

function startDrag(ev,foodType){
  ev.preventDefault();
  const clone=document.createElement('img'); clone.src='images/'+foodType+'.png'; clone.style.position='fixed'; clone.style.width='60px'; clone.style.opacity=0.8; clone.style.zIndex=1000; document.body.appendChild(clone);
  function moveHandler(e){ const t=e.touches?e.touches[0]:e; clone.style.left=t.clientX-30+'px'; clone.style.top=t.clientY-30+'px'; }
  function endHandler(e){ const t=e.changedTouches?e.changedTouches[0]:e;

    const plate=document.getElementById('plateWrapper').getBoundingClientRect();
    const dx=t.clientX-(plate.left+plate.width/2); const dy=t.clientY-(plate.top+plate.height/2-15);
    if(Math.sqrt(dx*dx+dy*dy)<=plate.width*0.4 && foodStock[foodType]>0){ selectedFood=foodType; const pf=document.getElementById('plateFood'); pf.src='images/'+foodType+'.png'; pf.style.display='block'; showBubble('üçΩÔ∏è '+foodType+' siap di piring!'); }
    clone.remove(); document.removeEventListener('mousemove',moveHandler); document.removeEventListener('mouseup',endHandler);
    document.removeEventListener('touchmove',moveHandler); document.removeEventListener('touchend',endHandler);

  }
  document.addEventListener('mousemove',moveHandler); document.addEventListener('mouseup',endHandler);
  document.addEventListener('touchmove',moveHandler); document.addEventListener('touchend',endHandler);
}

function setupButtons() {
  const feedBtn = document.getElementById("feedBtn");
  const playBtn = document.getElementById("playBtn");

  if (feedBtn && !feedBtn.dataset.bound) {
    feedBtn.addEventListener("click", Pet);
    feedBtn.dataset.bound = "true";
  }

  if (playBtn && !playBtn.dataset.bound) {
    playBtn.addEventListener("click", playWithPet);
    playBtn.dataset.bound = "true";
  }
}

function resetGame(){
  // Hapus semua data di localStorage
  localStorage.removeItem("petData");
  localStorage.removeItem("foodStock");

  // Reset pet
  pet = {
    level:1, exp:0, hunger:50, stage:"egg", coins:0,
    stats:{att:10,def:10,spd:10,acc:10,crit:10},
    statPoints:0, name:"Petku", owner:"Player1"
  };

  // Reset stok makanan
  foodStock = {meat:100, fruit:100, leaf:100};
  localStorage.setItem("foodStock", JSON.stringify(foodStock));

  updateUI();
}
  
function toggleShop(){
  const popup=document.getElementById("shopPopup");
  popup.style.display=(popup.style.display==="block"?"none":"block");
}

function buyItem(type,price){
  if(pet.coins < price){
    showBubble("Koin tidak cukup!");
    return;
  }
  pet.coins -= price;
  foodStock[type]++;

  // üîä Mainkan suara beli

  playSound("soundBuy");
  showBubble("Beli "+type+" berhasil! -"+price+" koin");
  updateUI();

  const coinDisplay=document.getElementById("coinDisplay");
  coinDisplay.style.transform="scale(1.2)";
  coinDisplay.style.opacity="0.5";
  setTimeout(()=>{
    coinDisplay.style.transform="scale(1)";
    coinDisplay.style.opacity="1";
  },300);
}

// ===================== STATS =====================
function toggleStats(){
  const p=document.getElementById("statsPopup");
  p.style.display=(p.style.display==="block"?"none":"block");
  if(p.style.display==="block"){ drawStatsChart(); updateStatUI(); }
}

function updateStatUI(){
  document.getElementById("statPoints").textContent = pet.statPoints;
  const btns = document.getElementById("statButtons");
  btns.innerHTML = "";

  Object.keys(pet.stats).forEach(key=>{
    const row = document.createElement("div");
    row.style.margin = "5px 0";

    // label jumlah stat
    const label = document.createElement("span");
    label.textContent = key.toUpperCase() + ": " + pet.stats[key] + " ";

    // tombol tambah
    const b = document.createElement("button");
    b.textContent = "+";
    b.disabled = pet.statPoints <= 0;
    b.onclick = ()=>{
  pet.stats[key]++;
  pet.statPoints--;
 updateStatUI();
  drawStatsChart();
  updateUI();
  showMiniBubble("+"+key.toUpperCase()); // ‚úÖ mini bubble muncul

};

    row.appendChild(label);
    row.appendChild(b);
    btns.appendChild(row);
  });
}


function drawStatsChart(){
  const c=document.getElementById("statsChart");
  const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  const keys=Object.keys(pet.stats);
  const maxVal=50; // skala maksimum
  const cx=c.width/2, cy=c.height/2, r=80;
  // draw polygon background
  ctx.strokeStyle="gray"; ctx.beginPath();
  keys.forEach((k,i)=>{
    const angle=(Math.PI*2/keys.length)*i - Math.PI/2;
    const x=cx+Math.cos(angle)*r;
    const y=cy+Math.sin(angle)*r;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });

  ctx.closePath(); ctx.stroke();

  // draw stat area
  ctx.fillStyle="rgba(0,150,255,0.5)"; ctx.beginPath();
  keys.forEach((k,i)=>{
    const val=pet.stats[k];
    const ratio=Math.min(1,val/maxVal);
    const angle=(Math.PI*2/keys.length)*i - Math.PI/2;
    const x=cx+Math.cos(angle)*r*ratio;
    const y=cy+Math.sin(angle)*r*ratio;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.closePath(); ctx.fill();
}

// =================================================
setInterval(()=>{ pet.hunger=Math.max(0,pet.hunger-5); if(pet.hunger<50&&Math.random()<0.3){showBubble("Aku lapar ü•∫");} updateUI(); },5000);
const petImg = document.getElementById("pet");

function tapEffect(){
  petImg.style.transition = "transform 0.4s ease, filter 0.4s ease";
  petImg.style.transform = "rotateY(15deg) rotateX(6deg) skewX(3deg) scale(1.05)";
  petImg.style.filter = "drop-shadow(15px 20px 12px rgba(0,0,0,0.6))";
  setTimeout(()=>{
    petImg.style.transform = "";
    petImg.style.filter = "";
  }, 500);
}
document.addEventListener("DOMContentLoaded", () => {
  const evoBtn = document.getElementById("evoBtn");
  evoBtn.addEventListener("click", evolvePet);
});

petImg.addEventListener("click", tapEffect);
petImg.addEventListener("touchstart", tapEffect);
  
</script>

<!-- ==================== END: MAIN GAME LOGIC ==================== -->

<!-- ==================== FIREBASE SDK (keharusan diletakkan AFTER game logic definitions) ==================== -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<!-- ==================== FIREBASE LOGIC / AUTH OBSERVER ==================== -->
<script>
// === KONFIGURASI FIREBASE ===
const firebaseConfig = {
  apiKey: "AIzaSyATd8wK3YMH9zQd-7HN9KT5cHnGgdPdKgU",
  authDomain: "game-pet-57451.firebaseapp.com",
  projectId: "game-pet-57451",
  storageBucket: "game-pet-57451.firebasestorage.app",
  messagingSenderId: "191423922230",
  appId: "1:191423922230:web:63ec169db83005cad05897"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

  firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL)
  .then(() => {
    console.log("‚úÖ Firebase persistence: LOCAL (login bertahan setelah reload)");
  })
  .catch((error) => {
    console.error("‚ùå Gagal set persistence:", error);
  });


// === LOGIN EMAIL OTP ===
function sendLoginLink() {
  const email = document.getElementById("emailInput").value.trim();
  if (!email) {
    alert("Masukkan email terlebih dahulu!");
    return;
  }

  const actionCodeSettings = {
    url: "https://nebulon22.github.io/Pet-Evolution/index.html",
    handleCodeInApp: true
  };

  auth.sendSignInLinkToEmail(email, actionCodeSettings)
    .then(() => {
      alert("‚úÖ Link OTP sudah dikirim ke " + email + "\nCek inbox atau folder spam.");
      localStorage.setItem("emailForSignIn", email);
    })
    .catch((error) => {
      alert("‚ùå Gagal kirim OTP: " + error.message);
    });
}


// === CEK LINK LOGIN (saat user klik dari email) ===
if (auth.isSignInWithEmailLink(window.location.href)) {
  let email = localStorage.getItem("emailForSignIn");
  if (!email) email = prompt("Masukkan email Anda untuk verifikasi:");

  auth.signInWithEmailLink(email, window.location.href)
    .then((result) => {
      alert("‚úÖ Login berhasil sebagai: " + result.user.email);
      localStorage.removeItem("emailForSignIn");
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("logoutBtn").style.display = "block";
      loadUserData(result.user.uid);
    })
    .catch((error) => {
      alert("‚ùå Login gagal: " + error.message);
    });
}

// === OBSERVER LOGIN STATE (FINAL HYBRID MODE) ===
auth.onAuthStateChanged((user) => {
  const loginBox = document.getElementById("loginBox");
  const logoutBtn = document.getElementById("logoutBtn");
  const emailIcon = document.getElementById("emailIcon");

  if (user) {
    // === ‚úÖ USER LOGIN ===
    console.log("üîë Login terdeteksi:", user.email);

    // Muat data lokal dulu (sementara menunggu cloud)
    const storedPet = localStorage.getItem("petData");
    const storedFood = localStorage.getItem("foodStock");
    if (storedPet) try { pet = JSON.parse(storedPet); } catch(e){ console.warn(e); }
    if (storedFood) try { foodStock = JSON.parse(storedFood); } catch(e){ console.warn(e); }

    // === Ambil data cloud ===
    loadUserData(user.uid)
      .then(() => {
        pet.owner = user.email || "Player";
        if (!pet.name) pet.name = "Pet Kamu üêæ";
        if (!pet.power) pet.power = 10;
        updateUI();
      })
      .catch((err) => {
        console.warn("‚ö†Ô∏è Gagal memuat data cloud:", err);
        // fallback ke data lokal
        const localPet = localStorage.getItem("petData");
        if (localPet) pet = JSON.parse(localPet);
        updateUI();
      });

    // === Atur tampilan login/logout ===
    if (loginBox) loginBox.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "inline-flex";
    if (emailIcon) {
      emailIcon.style.opacity = "0.3";
      emailIcon.style.pointerEvents = "none";
    }

    // === Tandai status login untuk mode offline ===
    localStorage.setItem("isLoggedIn", "true");
  }

  else {
    // === üö´ USER BELUM LOGIN / LOGOUT ===
    console.log("üö™ Tidak ada user aktif (mode guest).");

    // === Ambil data lokal agar tetap bisa main offline ===
    const storedPet = localStorage.getItem("petData");
    const storedFood = localStorage.getItem("foodStock");
    if (storedPet) try { pet = JSON.parse(storedPet); } catch(e){ console.warn(e); }
    if (storedFood) try { foodStock = JSON.parse(storedFood); } catch(e){ console.warn(e); }

    pet.owner = "Guest";
    evoAnimating = false;
    updateUI();

    // === Tampilkan UI mode guest ===
    if (loginBox) loginBox.style.display = "none"; // tidak perlu popup otomatis
    if (logoutBtn) logoutBtn.style.display = "none";
    if (emailIcon) {
      emailIcon.style.opacity = "1";
      emailIcon.style.pointerEvents = "auto";
    }

    // === Hapus flag login hybrid ===
    localStorage.removeItem("isLoggedIn");

    // ‚ö†Ô∏è Jangan hapus cache Firebase di sini (biarkan SDK yang urus)
  }
});


    // üîπ Atur UI login/logout
    if (loginBox) loginBox.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "inline-flex";
    if (emailIcon) {


// === LOGOUT ===
// === LOGOUT FINAL HYBRID MODE ===
function logout() {
  if (!confirm("Apakah yakin ingin logout?")) return;

  auth.signOut()
    .then(() => {
      console.log("‚úÖ Firebase: user berhasil logout.");

      // === Reset data game ke mode guest (tanpa hapus save lokal) ===
      pet = { name: "Pet", level: 1, exp: 0, stage: "egg", owner: "Guest" };
      coins = 0;
      inventory = {};
      foodStock = { meat: 100, fruit: 100, leaf: 100 };
      evoAnimating = false;
      selectedFood = null;

      // === Hapus cache login (AMAN untuk Chrome & browser lain) ===
      try {
        const key = "firebase:authUser:" + auth.name + ":" + auth.app.options.apiKey;
        localStorage.removeItem(key);            // cache Firebase
        localStorage.removeItem("isLoggedIn");   // flag hybrid
        localStorage.removeItem("emailForSignIn"); // email OTP login
      } catch (e) {
        console.warn("‚ö†Ô∏è Tidak bisa hapus cache Firebase:", e);
      }

      // === Kosongkan identitas user ===
      pet.owner = "Guest";

      // === Perbarui tampilan UI ===
      const logoutBtn = document.getElementById("logoutBtn");
      const loginBox = document.getElementById("loginBox");
      if (logoutBtn) logoutBtn.style.display = "none";
      if (loginBox) loginBox.style.display = "block";
      updateUI();

      // === Beri notifikasi visual ===
      alert("üëã Anda telah logout.");
      showBubble("Anda keluar dari akun.");

      console.log("üéØ Logout selesai ‚Äî mode guest aktif.");
    })
    .catch((error) => {
      alert("‚ùå Gagal logout: " + error.message);
      console.error("Logout error:", error);
    });
}

// === SIMPAN DATA USER KE FIRESTORE ===

function saveUserData(uid) {
  if (!uid || !pet) return;

  db.collection("users").doc(uid).set({
    pet: pet,
    foodStock: foodStock,
    coins: pet.coins,
    updatedAt: Date.now()
  }, { merge: true })
  .then(() => console.log("‚òÅÔ∏è Data tersimpan ke cloud"))
  .catch((err) => console.error("Gagal simpan data:", err));
}


// === MUAT DATA USER DARI FIRESTORE ===
function loadUserData(uid) {
  return new Promise((resolve, reject) => {
    db.collection("users").doc(uid).get()
      .then((doc) => {
        if (doc.exists) {
          const data = doc.data();

          // üîπ Periksa mana yang lebih tinggi: lokal vs cloud
          const localPet = JSON.parse(localStorage.getItem("petData") || "{}");
          const localLevel = localPet.level || 1;
          const cloudLevel = data.pet?.level || 1;

          if (localLevel > cloudLevel) {
            console.log("üì° Cloud lebih rendah, kirim data lokal ke cloud");
            saveUserData(uid); // kirim ke cloud data lokal
          } else {
            console.log("‚òÅÔ∏è Data cloud dimuat (level " + cloudLevel + ")");
            pet = data.pet || pet;
            foodStock = data.foodStock || foodStock;
            pet.coins = data.coins || pet.coins;

            // ‚úÖ Pastikan owner & power tidak kosong
            pet.owner = data.pet?.owner || firebase.auth().currentUser?.email || "Player";
            if (!pet.name) pet.name = "Pet Kamu üêæ";
            if (!pet.power) pet.power = 10;

            // Simpan ke lokal
            localStorage.setItem("petData", JSON.stringify(pet));
            localStorage.setItem("foodStock", JSON.stringify(foodStock));
          }

          updateUI();
          resolve(data);
        } else {
          console.log("üî∞ User baru ‚Äî membuat data default di cloud");
          saveUserData(uid);
          resolve(null);
        }
      })
      .catch((error) => {
        console.error("‚ùå Gagal memuat data user:", error);
        reject(error);
      });
  });
}



// === AUTO-SAVE SETIAP 30 DETIK ===
setInterval(() => {
  const user = auth.currentUser;
  if (user) saveUserData(user.uid);
}, 30000);
</script>

<!-- ==================== END: FIREBASE LOGIC ==================== -->

<!-- ==================== INIT / DRAG OBSERVER & HYBRID INIT ==================== -->
<script>
  // Pastikan init berjalan walau DOM sudah ready atau script ditempatkan akhir
  function initGame() {
    console.log("üöÄ initGame()");
    try {
      // updateUI dan setupButtons sudah didefinisikan di main game logic
      updateUI();
      setupButtons();
      activateDragObserver();
      console.log("‚úÖ Game init selesai");
    } catch (err) {
      console.error("‚ùå initGame error:", err);
    }
  }

  // Jika DOM sudah siap, panggil langsung. Jika belum, tunggu DOMContentLoaded
  if (document.readyState === "loading") {
    document.addEventListener('DOMContentLoaded', initGame);
  } else {
    initGame();
  }

  // ActivateDragObserver: memanggil setupDrag() dan memasang MutationObserver pada foodGrid
  function activateDragObserver() {
    try {
      setupDrag();
      const grid = document.getElementById('foodGrid');
      if (!grid) return;
      const observer = new MutationObserver((mutations) => {
        const hasSlotChange = mutations.some(m => m.addedNodes.length || m.removedNodes.length);
        if (hasSlotChange) setupDrag();
      });
      observer.observe(grid, { childList: true, subtree: true });
      console.log('‚úÖ Drag observer aktif');
    } catch (e) {
      console.warn('‚ö†Ô∏è activateDragObserver failed', e);
    }
  }

  // Pastikan #pet menggunakan CSS variable animation (cadangan)
  (function ensurePetAnimVar(){
    const s = document.createElement('style');
    s.textContent = '#pet{ animation: var(--pet-anim, idleMotion 6s ease-in-out infinite, breathing 3s infinite); }';
    document.head.appendChild(s);
  })();

</script>

</body>
</html>










